# See accompanying README.md for details about this file.

config:
  log_level: DEBUG
  output_dir: ${OUTPUT_DIR}
  memory_limit: 1GB
  state_file: ./runs.csv
  show_graph: False
  parameter_defaults:
    STUDENT_ID_JOIN_COLUMN: Student_StateID
    STUDENT_ID_NAME: Student_StateID
    STUDENT_ID_XWALK: ''
    

  

sources:
  assessmentReportingMethodDescriptors:
    file: ${BUNDLE_DIR}/seeds/assessmentReportingMethodDescriptors.csv
    header_rows: 1
  performanceLevelDescriptors:
    file: ${BUNDLE_DIR}/seeds/performanceLevelDescriptors.csv
    header_rows: 1
  assessments:
    file: ${BUNDLE_DIR}/seeds/assessments.csv
    header_rows: 1

  nwea_map_input:
    # THIS FILE DOES NOT EXIST; IT MUST BE SUPPLIED BY THE USER!
    file: ${INPUT_FILE}
    header_rows: 1
    # See the accompanying README.md for a list of required columns for this file
  
  student_id_xwalk:
    # This file only needs to be supplied if the source assessment file does not
    # contain the studentUniqueId used by Ed-Fi
    file: ${STUDENT_ID_XWALK}
    header_rows: 1
    columns: 
      - from 
      - to
    optional: True 
  
# notes:
# - left out all seasontoseasonGrowthQuintile


transformations:
  nwea_map_student_assessment:
    operations:
      - operation: join 
        sources: 
          - $sources.nwea_map_input
          - $sources.student_id_xwalk
        left_key: ${STUDENT_ID_JOIN_COLUMN}
        right_key: from
        join_type: left
      - operation: duplicate_columns
        source: $transformations.nwea_map_student_assessment
        columns: 
          ${STUDENT_ID_NAME}: studentUniqueId
      - operation: add_columns
        source: $transformations.nwea_map_student_assessment
        columns:
          school_year: "{%raw%}{{TermName[-4:]}}{%endraw%}"
      - operation: date_format
        source: $transformations.nwea_map_student_assessment
        column: TestStartDate
        from_format: "%m/%d/%Y"
        to_format: "%Y-%m-%d"
  {% for i in range(1, 9) %} 
  goal_{{i}}:
    operations:
      - operation: keep_columns
        source: $sources.nwea_map_input
        columns: 
          - Goal{{i}}Name
      - operation: distinct_rows
        source: $transformations.goal_{{i}}
      - operation: rename_columns
        source: $transformations.goal_{{i}}
        columns: 
          Goal{{i}}Name: identificationCode
    {%  endfor %}
  
  objective_assessments:
    operations: 
      - operation: union
        sources:
          {% for i in range(1, 9) %} 
          - $transformations.goal_{{i}}
          {%  endfor %}
      - operation: filter_rows
        source: $transformations.objective_assessments
        query: identificationCode != ''
        behavior: include
      - operation: distinct_rows
        source: $transformations.objective_assessments


  {% for i in range(1, 10) %}
  proj_prof_{{i}}:
    operations:
      - operation: keep_columns
        source: $sources.nwea_map_input
        columns: 
          - ProjectedProficiencyStudy{{i}}
      - operation: distinct_rows
        source: $transformations.proj_prof_{{i}}
      - operation: rename_columns
        source: $transformations.proj_prof_{{i}}
        columns: 
          ProjectedProficiencyStudy{{i}}: codeValue
  {% endfor %}

  proj_prof:
    operations: 
      - operation: union
        sources:
        {% for i in range(1, 10) %}
          - $transformations.proj_prof_{{i}}
        {% endfor %}
      - operation: filter_rows
        source: $transformations.proj_prof
        query: codeValue != ''
        behavior: include
      - operation: distinct_rows
        source: $transformations.proj_prof
      - operation: add_columns
        source: $transformations.proj_prof
        columns:
          description: Projected Proficiency in linked assessment
          namespace: uri://www.nwea.org/map/AssessmentReportingMethodDescriptor
          shortDescription: Projected Proficiency
          column_name: ProjectedProficiencyStudy
          data_type: Level
          is_deprecated: False
          score_or_performance: score

  reporting_methods:
    operations: 
      - operation: filter_rows
        source: $sources.assessmentReportingMethodDescriptors
        query: is_deprecated == 'False'
        behavior: include
      - operation: union
        sources:
          - $transformations.reporting_methods
          - $transformations.proj_prof

destinations:
  assessmentReportingMethodDescriptors:
    source: $transformations.reporting_methods
    template: ${BUNDLE_DIR}/templates/assessmentReportingMethodDescriptors.jsont
    extension: jsonl
    linearize: True
  performanceLevelDescriptors:
    source: $sources.performanceLevelDescriptors
    template: ${BUNDLE_DIR}/templates/performanceLevelDescriptors.jsont
    extension: jsonl
    linearize: True
  assessments:
    source: $sources.assessments
    template: ${BUNDLE_DIR}/templates/assessments.jsont
    extension: jsonl
    linearize: True
  objectiveAssessments:
    source: $transformations.objective_assessments
    template: ${BUNDLE_DIR}/templates/objectiveAssessments.jsont
    extension: jsonl
    linearize: True
  studentAssessments:
    source: $transformations.nwea_map_student_assessment
    template: ${BUNDLE_DIR}/templates/studentAssessment.jsont
    extension: jsonl
    linearize: True
