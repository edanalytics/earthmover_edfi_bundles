config:
  output_dir: /tmp/
  # memory_limit: 2GB
  # show_stacktrace: True
  # show_graph: True
  # log_level: DEBUG

sources:
  assessments:
    file: ${BUNDLE_DIR}/seeds/assessments.csv
    header_rows: 1
  performanceLevelDescriptors:
    file: ${BUNDLE_DIR}/seeds/performanceLevelDescriptors.csv
    header_rows: 1
  assessmentReportingMethodDescriptors:
    file: ${BUNDLE_DIR}/seeds/assessmentReportingMethodDescriptors.csv
    header_rows: 1

  nwea_map_fluency_input:
    file: ${INPUT_FILE}
    header_rows: 1
  grade_levels_xwalk:
    file: ${BUNDLE_DIR}/seeds/grade_levels_xwalk.csv

transformations:
  nwea_map_student_assessment:
    operations:
      - operation: duplicate_columns
        source: $sources.nwea_map_fluency_input
        columns:
          ${STUDENT_ID_NAME}: studentUniqueId
      - operation: add_columns
        source: $transformations.nwea_map_student_assessment
        columns:
          school_year: "{%raw%}{{TermName[-4:]}}{%endraw%}"
      - operation: date_format
        source: $transformations.nwea_map_student_assessment
        column: TestCompletionDate
        from_format: "%m/%d/%Y"
        to_format: "%Y-%m-%d"
      - operation: combine_columns
        source: $transformations.nwea_map_student_assessment
        columns:
          - studentUniqueId
          - TermName
          - TestCompletionDate
        new_column: generated_test_id
        separator: '-'
      - operation: join
        sources: 
          - $transformations.nwea_map_student_assessment
          - $sources.grade_levels_xwalk
        left_key: Grade
        right_key: assessed_grade_level
        right_keep_columns: [edfi_grade_level]
        join_type: left

destinations:
  studentAssessments:
    source: $transformations.nwea_map_student_assessment
    template: ./templates/studentAssessments.jsont
    extension: jsonl
    linearize: True
  assessments:
    source: $sources.assessments
    template: ${BUNDLE_DIR}/templates/assessments.jsont
    extension: jsonl
    linearize: True
  performanceLevelDescriptors:
    source: $sources.performanceLevelDescriptors
    template: ${BUNDLE_DIR}/templates/performanceLevelDescriptors.jsont
    extension: jsonl
  assessmentReportingMethodDescriptors:
    source: $sources.assessmentReportingMethodDescriptors
    template: ${BUNDLE_DIR}/templates/assessmentReportingMethodDescriptors.jsont
    extension: jsonl