# See accompanying README.md for details about this file.
version: 2

config:
  log_level: DEBUG
  output_dir: assessments/CLI_Circle/output
  memory_limit: 1GB
  state_file: ./runs.csv
  show_headers: True
  show_stacktrace: True
  show_graph: True
  parameter_defaults:
    STUDENT_ID_JOIN_COLUMN: local_student_id


sources:
  cli_circle_input:
    # THIS FILE DOES NOT EXIST; IT MUST BE SUPPLIED BY THE USER!
    file: '/mnt/n/texas_esc_4/data/assessment/cli circle/lamar_cisd/CircleDataExport_CIRCLE Progress Monitoring Pre-K Results Export_20220618_031032842D80A/report.csv'
    header_rows: 3

{% set conformed_columns = [
  'student_wave_id', 
  'wave',
  'school_year',
  'district_number',
  'community_name',
  'community_engage_id',
  'school_number',
  'school_name',
  'school_engage_id',
  'school_type',
  'school_status',
  'teacher_number',
  'homeroom_teacher',
  'teacher_engage_id',
  'teacher_state_id',
  'teacher_primary_email',
  'class_internal_id',
  'class_name',
  'class_engage_id',
  'class_status',
  'day_type',
  'class_level',
  'local_student_id',
  'student_first_name',
  'student_middle_name',
  'student_last_name',
  'student_dob',
  'student_status',
  'student_engage_id',
  'student_state_id',
  'assessment_language',
  'student_gender',
  'student_ethnicity',
  'student_grade_level',
  'collaboration_id',
  'special_ed',
  'special_ed_former',
  'english_language_learner',
  'econ_disadvantaged',
  'dyslexia',
  'enrollment_date',
  'withdrawal_date',
  'assessment_code',
  'assessment_descriptor',
  'assessment_score',
  'assessment_performance',
  'assessment_date',
  'oa_category_1_name',
  'oa_category_2_name',
  'oa_category_3_name',
  'oa_category_4_name',
  'oa_category_5_name',
  'oa_category_6_name',
  'oa_category_7_name',
  'oa_category_1_descriptor',
  'oa_category_2_descriptor',
  'oa_category_3_descriptor',
  'oa_category_4_descriptor',
  'oa_category_5_descriptor',
  'oa_category_6_descriptor',
  'oa_category_7_descriptor',
  'oa_category_1_date',
  'oa_category_2_date',
  'oa_category_3_date',
  'oa_category_4_date',
  'oa_category_5_date',
  'oa_category_6_date',
  'oa_category_7_date',
  'oa_category_1_score',
  'oa_category_2_score',
  'oa_category_3_score',
  'oa_category_4_score',
  'oa_category_5_score',
  'oa_category_6_score',
  'oa_category_7_score',
  'oa_category_1_performance',
  'oa_category_2_performance',
  'oa_category_3_performance',
  'oa_category_4_performance',
  'oa_category_5_performance',
  'oa_category_6_performance',
  'oa_category_7_performance'
  ] 
%}

{% set assessments = {
    'rln_v1': {
      'name': 'Rapid Letter Naming',
      'objective_assessments': []
    },
    'rapid_vocabulary_v1': {
      'name': 'Rapid Vocabulary',
      'objective_assessments': [
        {'oa_category_1':{'rapid_vocabulary_v1_rv_set1_v1': 'Rapid Vocabulary Set 1'}},
        {'oa_category_2':{'rapid_vocabulary_v1_rv_set2_v1': 'Rapid Vocabulary Set 2'}},
        {'oa_category_3':{'rapid_vocabulary_v1_rv_set3_v1': 'Rapid Vocabulary Set 3'}}
      ]
    },
    'pa_v2': {
      'name': 'Phonological Awareness',
      'objective_assessments': [
        {'oa_category_1':{'pa_v2_syllabication_v2': 'Phonological Awareness Syllabication'}},
        {'oa_category_2':{'pa_v2_onset_rime_v2': 'Phonological Awareness Onset-Rime'}},
        {'oa_category_3':{'pa_v2_alliteration_v2': 'Phonological Awareness Alliteration'}},
        {'oa_category_4':{'pa_v2_rhyming_i_v2': 'Phonological Awareness Rhyming I'}}
      ]
    },
    'pa_opt_v1': {
      'name': 'Optional Phonological Awareness',
      'objective_assessments': [
        {'oa_category_1':{'pa_opt_v1_listening_v2': 'Optional Phonological Awareness Listening'}},
        {'oa_category_2':{'pa_opt_v1_words_v2': 'Optional Phonological Awareness Words in a Sentence'}},
        {'oa_category_3':{'pa_opt_v1_rhyming_ii_v2': 'Optional Phonological Awareness Rhyming II'}}
      ]
    },
    'math_v1': {
      'name': 'Math',
      'objective_assessments': [
        {'oa_category_1':{'math_v1_rote_counting_v1': 'Math Rote Counting'}},
        {'oa_category_2':{'math_v1_shape_naming_v1': 'Math Shape Naming'}},
        {'oa_category_3':{'math_v1_number_discrimination_v1': 'Math Number Discrimination'}},
        {'oa_category_4':{'math_v1_number_naming_v1': 'Math Number Naming'}},
        {'oa_category_5':{'math_v1_shape_disc_v1': 'Math Shape Discrimination'}},
        {'oa_category_6':{'math_v1_counting_v1': 'Math Counting Sets'}},
        {'oa_category_7':{'math_v1_operations_v1': 'Math Operations'}}
      ]
    },
    'math_opt_v1': {
      'name': 'Optional Math',
      'objective_assessments': [
        {'oa_category_1':{'math_opt_v1_patterns_v1': 'Optional Math Patterns'}},
        {'oa_category_2':{'math_opt_v1_real_world_v1': 'Optional Math Real World'}}
      ]
    },
    'letter_sound_v1': {
      'name': 'Letter-Sound Correspondence',
      'objective_assessments': []
    },
    'story_retell_comp_v1': {
      'name': 'Story Retell and Comprehension',
      'objective_assessments': []
    },
    'book_print_v1': {
      'name': 'Book and Print Knowledge',
      'objective_assessments': []
    },
    'science_v1': {
      'name': 'Science',
      'objective_assessments': []
    },
    'social_studies_v1': {
      'name': 'Social Studies',
      'objective_assessments': []
    },
    'social_emotional_v1': {
      'name': 'Social Emotional Behaviors',
      'objective_assessments': [
        {'oa_category_1':{'social_emotional_v1_positive_social_v1': 'Positive Social Behaviors'}},
        {'oa_category_2':{'social_emotional_v1_classroom_community_safety_v1': 'Classroom Community and Safety'}},
        {'oa_category_3':{'social_emotional_v1_emotion_behavior_v1': 'Emotion and Behavior Regulation'}},
        {'oa_category_4':{'social_emotional_v1_self_care_v1': 'Self-Care'}},
        {'oa_category_5':{'social_emotional_v1_approaches_to_learning_v1': 'Approaches to Learning'}}
      ]
    },
    'early_writing_v1': {
      'name': 'Early Writing Skills Early Writing Skills',
      'objective_assessments': []
    },
    'approaches_to_learning_exp_v2': {
      'name': 'Approaches to Learning Expanded',
      'objective_assessments': [
        {'oa_category_1':{'approaches_to_learning_exp_v2_initiative_curiosity_v1': 'Initiative and Curiosity'}},
        {'oa_category_2':{'approaches_to_learning_exp_v2_flexibility_v1': 'Flexibility'}},
        {'oa_category_3':{'approaches_to_learning_exp_v2_creativity_dramatic_play_v1': 'Total Score Art/Creativity and Dramatic Play'}}
      ]
    },
    'physical_dev_health_v1': {
      'name': 'Physical Development and Health',
      'objective_assessments': [
        {'oa_category_1':{'physical_dev_health_v1_fine_visual_motor_v1': 'Fine and Visual Motor'}},
        {'oa_category_2':{'physical_dev_health_v1_gross_motor_v1': 'Gross Motor'}},
        {'oa_category_3':{'physical_dev_health_v1_health_v1': 'Health Status'}}
      ]
    },
    'language_communication_2016_v1': {
      'name': 'Speech Production and Sentence Skills',
      'objective_assessments': []
    },
    'motivation_to_read_2016_v1': {
      'name': 'Motivation to Read - En',
      'objective_assessments': []
    },
    'cpm_admin_mode': {
      'name': 'Administration Mode',
      'objective_assessments': []
    }
  }
%}

{% set non_cp_columns = [      
  'approaches_to_learning_exp_v2_creativity_dramatic_play_v1',
  'approaches_to_learning_exp_v2_flexibility_v1',
  'approaches_to_learning_exp_v2_initiative_curiosity_v1',
  'cpm_admin_mode',
  'math_opt_v1_patterns_v1',
  'math_opt_v1_real_world_v1',
  'physical_dev_health_v1_fine_visual_motor_v1',
  'physical_dev_health_v1_gross_motor_v1',
  'physical_dev_health_v1_health_v1',
  'social_emotional_v1_approaches_to_learning_v1',
  'social_emotional_v1_self_care_v1',
  'social_emotional_v1_emotion_behavior_v1',
  'social_emotional_v1_classroom_community_safety_v1',
  'social_emotional_v1_positive_social_v1'
] 
%}

transformations:
  cli_circle_student_assessment:
    source: $sources.cli_circle_input
    operations:
      - operation: snake_case_columns 
      - operation: add_columns
        columns:
          student_wave_id: '{%raw%}{{wave}}_{{school_year}}_{{local_student_id}}{%endraw%}'

{% for assessment_code, assessment_values in assessments.items() %}
  cli_circle_student_{{assessment_code}}:
    source: $transformations.cli_circle_student_assessment
    header_rows: 1
    show_headers: True
    operations:
      - operation: rename_columns
        columns:
          {{ assessment_code }}: assessment_score
          {{ assessment_code }}_date: assessment_date

      {% if assessment_code not in non_cp_columns %}
      - operation: rename_columns
        columns:
          cp_{{ assessment_code }}: assessment_performance
      {% else %}
      - operation: add_columns
        columns:
          assessment_performance: ''
      {% endif %}

      - operation: add_columns
        columns:
          assessment_code: {{ assessment_code }}
          assessment_descriptor: {{ assessment_values.name }}

      {% if assessment_values.objective_assessments is not none and assessment_values.objective_assessments | length %}
      {% set cat_numbers=[] -%}
      {% for objective_assessment in assessment_values.objective_assessments %}
        {% for oa_category, oa_values in objective_assessment.items() %}
          {% for oa_key, oa_value in oa_values.items() %}
      - operation: rename_columns
        columns:
          {{ oa_key }}: {{ oa_category }}_score
          {{ oa_key }}_date: {{ oa_category }}_date
          
            {% if oa_key not in non_cp_columns %}
      - operation: rename_columns
        columns:
          cp_{{ oa_key }}: {{ oa_category }}_performance
            {% else %}
      - operation: add_columns
        columns:
          {{ oa_category }}_performance: ''              
            {% endif %}
      - operation: add_columns
        columns:
          {{ oa_category }}_name: {{ oa_key }}
          {{ oa_category }}_descriptor: {{ oa_value }}
          {% set cat_number = cat_numbers.append(oa_category.split('_')[-1]) %}          
          {% endfor %}     
        {% endfor %}
      {% endfor %}
      
        {% for n in range(1, 8) %}
          {% if n|string not in cat_numbers %}
      - operation: add_columns
        columns:
          oa_category_{{ n }}_name: ''  
          oa_category_{{ n }}_descriptor: '' 
          oa_category_{{ n }}_date: '' 
          oa_category_{{ n }}_score: '' 
          oa_category_{{ n }}_performance: '' 
          {%- endif -%}      
        {%- endfor -%}
      
      {% else %}
      - operation: add_columns
        columns:
          oa_category_1_name: ''
          oa_category_2_name: ''
          oa_category_3_name: ''
          oa_category_4_name: ''
          oa_category_5_name: ''
          oa_category_6_name: ''
          oa_category_7_name: ''
          oa_category_1_descriptor: ''
          oa_category_2_descriptor: ''
          oa_category_3_descriptor: ''
          oa_category_4_descriptor: ''
          oa_category_5_descriptor: ''
          oa_category_6_descriptor: ''
          oa_category_7_descriptor: ''
          oa_category_1_date: ''
          oa_category_2_date: ''
          oa_category_3_date: ''
          oa_category_4_date: ''
          oa_category_5_date: ''
          oa_category_6_date: ''
          oa_category_7_date: ''
          oa_category_1_score: ''
          oa_category_2_score: ''
          oa_category_3_score: ''
          oa_category_4_score: ''
          oa_category_5_score: ''
          oa_category_6_score: ''
          oa_category_7_score: ''  
          oa_category_1_performance: ''
          oa_category_2_performance: ''
          oa_category_3_performance: ''
          oa_category_4_performance: ''
          oa_category_5_performance: ''
          oa_category_6_performance: ''
          oa_category_7_performance: ''  
      {% endif %}

      - operation: filter_rows
        query: assessment_score != '' and assessment_date != ''
        behavior: include 

      - operation: keep_columns
        columns: {{conformed_columns}}
        debug: True
        header_rows: 1
        show_headers: True

{% endfor %}

  stacked_assessment_scores:
    source: $transformations.cli_circle_student_rln_v1
    operations:
      - operation: union
        debug: True
        sources:
{% for assessment_code, assessment_values in assessments.items() %}
    {% if assessment_code != 'rln_v1' %}
          - $transformations.cli_circle_student_{{ assessment_code }}
    {% endif %}  
{% endfor %} 

destinations:
  studentAssessments:
    source: $transformations.stacked_assessment_scores
    template: assessments/CLI_Circle/templates/studentAssessments.jsont
    extension: json
    linearize: False
    show_progress: True