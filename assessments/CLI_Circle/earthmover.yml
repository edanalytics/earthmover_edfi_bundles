# See accompanying README.md for details about this file.
version: 2

config:
  log_level: DEBUG
  output_dir: assessments/CLI_Circle/output
  memory_limit: 1GB
  state_file: ./runs.csv
  show_graph: False
  parameter_defaults:
    STUDENT_ID_JOIN_COLUMN: local_student_id


sources:
  cli_circle_input:
    # THIS FILE DOES NOT EXIST; IT MUST BE SUPPLIED BY THE USER!
    file: '/mnt/n/texas_esc_4/data/assessment/cli circle/lamar_cisd/CircleDataExport_CIRCLE Progress Monitoring Pre-K Results Export_20220618_031032842D80A/report.csv'
    header_rows: 3
    # See the accompanying README.md for a list of required columns for this file

  assessments:
    file: assessments/CLI_Circle/seeds/assessments.csv
    header_rows: 1
  assessmentReportingMethodDescriptors:
    file: assessments/CLI_Circle/seeds/assessmentReportingMethodDescriptors.csv
    header_rows: 1


{% set conformed_columns = [
  'student_assessment_id', 
  'wave',
  'school_year',
  'district_number',
  'community_name',
  'community_engage_id',
  'school_number',
  'school_name',
  'school_engage_id',
  'school_type',
  'school_status',
  'teacher_number',
  'homeroom_teacher',
  'teacher_engage_id',
  'teacher_state_id',
  'teacher_primary_email',
  'class_internal_id',
  'class_name',
  'class_engage_id',
  'class_status',
  'day_type',
  'class_level',
  'local_student_id',
  'student_first_name',
  'student_middle_name',
  'student_last_name',
  'student_dob',
  'student_status',
  'student_engage_id',
  'student_state_id',
  'assessment_language',
  'student_gender',
  'student_ethnicity',
  'student_grade_level',
  'collaboration_id',
  'special_ed',
  'special_ed_former',
  'english_language_learner',
  'econ_disadvantaged',
  'dyslexia',
  'enrollment_date',
  'withdrawal_date',
  'assessment',
  'assessment_code',
  'assessment_score',
  'assessment_date',
  'assessment_performance',
  'objective_assessment',
  'objective_assessment_code',
  'objective_assessment_score',
  'objective_assessment_date',
  'objective_assessment_performance'
  ] 
%}

{% set assessments = {
  'rln_v1': 'Rapid Letter Naming',
  'rapid_vocabulary_v1': 'Rapid Vocabulary',
  'pa_v2': 'Phonological Awareness',
  'pa_opt_v1': 'Optional Phonological Awareness',
  'math_v1': 'Math',
  'math_opt_v1': 'Optional Math',
  'letter_sound_v1': 'Letter-Sound Correspondence',
  'story_retell_comp_v1': 'Story Retell and Comprehension',
  'book_print_v1': 'Book and Print Knowledge',
  'science_v1': 'Science',
  'social_studies_v1': 'Social Studies',
  'social_emotional_v1': 'Social Emotional Behaviors',
  'early_writing_v1': 'Early Writing Skills Early Writing Skills',
  'approaches_to_learning_exp_v2': 'Approaches to Learning Expanded',
  'approaches_to_learning_exp_v2_initiative_curiosity_v1': 'Initiative and Curiosity',
  'approaches_to_learning_exp_v2_flexibility_v1': 'Flexibility',
  'approaches_to_learning_exp_v2_creativity_dramatic_play_v1': 'Total Score Art/Creativity and Dramatic Play',
  'physical_dev_health_v1': 'Physical Development and Health',
  'language_communication_2016_v1': 'Speech Production and Sentence Skills',
  'motivation_to_read_2016_v1': 'Motivation to Read - En',
  'cpm_admin_mode': 'Administration Mode'
  }
%}

{% set objective_assessments = {
  'rapid_vocabulary_v1_rv_set1_v1': 'Rapid Vocabulary Set 1',
  'rapid_vocabulary_v1_rv_set2_v1': 'Rapid Vocabulary Set 2',
  'rapid_vocabulary_v1_rv_set3_v1': 'Rapid Vocabulary Set 3',
  'pa_v2_syllabication_v2': 'Phonological Awareness Syllabication',
  'pa_v2_onset_rime_v2': 'Phonological Awareness Onset-Rime',
  'pa_v2_alliteration_v2': 'Phonological Awareness Alliteration',
  'pa_v2_rhyming_i_v2': 'Phonological Awareness Rhyming I',
  'pa_opt_v1_listening_v2': 'Optional Phonological Awareness Listening',
  'pa_opt_v1_words_v2': 'Optional Phonological Awareness Words in a Sentence',
  'pa_opt_v1_rhyming_ii_v2': 'Optional Phonological Awareness Rhyming II',
  'math_v1_rote_counting_v1': 'Math Rote Counting',
  'math_v1_shape_naming_v1': 'Math Shape Naming',
  'math_v1_number_discrimination_v1': 'Math Number Discrimination',
  'math_v1_number_naming_v1': 'Math Number Naming',
  'math_v1_shape_disc_v1': 'Math Shape Discrimination',
  'math_v1_counting_v1': 'Math Counting Sets',
  'math_v1_operations_v1': 'Math Operations',
  'math_opt_v1_patterns_v1': 'Optional Math Patterns',
  'math_opt_v1_real_world_v1': 'Optional Math Real World',
  'social_emotional_v1_positive_social_v1': 'Positive Social Behaviors',
  'social_emotional_v1_classroom_community_safety_v1': 'Classroom Community and Safety',
  'social_emotional_v1_emotion_behavior_v1': 'Emotion and Behavior Regulation',
  'social_emotional_v1_self_care_v1': 'Self-Care',
  'social_emotional_v1_approaches_to_learning_v1': 'Approaches to Learning',
  'physical_dev_health_v1_fine_visual_motor_v1': 'Fine and Visual Motor',
  'physical_dev_health_v1_gross_motor_v1': 'Gross Motor',
  'physical_dev_health_v1_health_v1': 'Health Status'
  }
%}

{% set non_cp_columns = [      
  'approaches_to_learning_exp_v2_creativity_dramatic_play_v1',
  'approaches_to_learning_exp_v2_flexibility_v1',
  'approaches_to_learning_exp_v2_initiative_curiosity_v1',
  'cpm_admin_mode',
  'math_opt_v1_patterns_v1',
  'math_opt_v1_real_world_v1',
  'physical_dev_health_v1_fine_visual_motor_v1',
  'physical_dev_health_v1_gross_motor_v1',
  'physical_dev_health_v1_health_v1',
  'social_emotional_v1_approaches_to_learning_v1',
  'social_emotional_v1_self_care_v1',
  'social_emotional_v1_emotion_behavior_v1',
  'social_emotional_v1_classroom_community_safety_v1',
  'social_emotional_v1_positive_social_v1'
] 
%}

transformations:
  cli_circle_student_assessment:
    source: $sources.cli_circle_input
    operations:
      - operation: snake_case_columns  
      # RENAME columns to easily convert from wide to long
      - operation: add_columns
        columns:
          student_assessment_id: '{%raw%}{{wave}}_{{school_year}}_{{local_student_id}}{%endraw%}'

  # CONVERT ASSESSMENT DATA FROM WIDE TO LONG
  {% for assessment in assessments %}
  {% set descriptor_assessment = assessments[assessment] %}
  cli_circle_scores_{{assessment}}:
    source: $transformations.cli_circle_student_assessment
    operations:
      # RENAME assessment-specific columns to generic colnames so we can stack the data long
      - operation: rename_columns
        columns:
          {{assessment}}: assessment_score
          {{assessment}}_date: assessment_date
        # Handling assessments without cut point (cp) values to prevent errors
      {% if assessment not in non_cp_columns %}
          cp_{{assessment}}: assessment_performance
      {% else %}
      - operation: add_columns
        columns:
          assessment_performance: ''
      {% endif %}
      # ADD additional columns needed for JSON parsing
      - operation: add_columns
        columns:
          assessment: {{descriptor_assessment}}
          assessment_code: {{assessment}}
          objective_assessment: ''
          objective_assessment_code: ''
          objective_assessment_score: ''
          objective_assessment_date: ''
          objective_assessment_performance: ''
      # FILTER columns without assessment scores or assessment dates
      - operation: filter_rows
        query: assessment_score != '' and assessment_date != ''
        behavior: include 
      - operation: keep_columns
        columns: {{conformed_columns}}
  {% endfor %}

  # JOIN DATA TOGETHER FOR FUTURE TRANSFORMATIONS
  stacked_assessment_scores:
    source: $transformations.cli_circle_scores_rln_v1
    operations:
      - operation: union
        sources:
  {% for assessment in assessments %}
          - $transformations.cli_circle_scores_{{ assessment }}
  {% endfor %}



  # CONVERT OBJECTIVE ASSESSMENT DATA FROM WIDE TO LONG
  {% for objective_assessment in objective_assessments %}
  {% set descriptor_objective_assessment = objective_assessments[objective_assessment] %}
  cli_circle_scores_{{objective_assessment}}:
    source: $transformations.cli_circle_student_assessment
    operations:
      # RENAME assessment-specific columns to generic colnames so we can stack the data long
      - operation: rename_columns
        columns:
          {{objective_assessment}}: objective_assessment_score
          {{objective_assessment}}_date: objective_assessment_date
        # Handling assessments without cut point (cp) values to prevent errors
      {% if objective_assessment not in non_cp_columns %}
          cp_{{objective_assessment}}: objective_assessment_performance
      {% else %}
      - operation: add_columns
        columns:
          objective_assessment_performance: ''
      {% endif %}
      # ADD additional columns needed for JSON parsing
      - operation: add_columns
        columns:
      {% for assessment in assessments %}
        {% set condition_met = false %}
        {% if not condition_met and assessment|string in objective_assessment|string%}
          {% set condition_met = true %}
          assessment: {{descriptor_assessment}}
          assessment_code: {{assessment}}
        {% endif %}
      {% endfor %}
          objective_assessment: {{descriptor_objective_assessment}}
          objective_assessment_code: {{objective_assessment}}
          assessment_score: ''
          assessment_date: ''
          assessment_performance: ''
      # FILTER columns without assessment scores or assessment dates
      - operation: filter_rows
        query: objective_assessment_score != '' and objective_assessment_date != ''
        behavior: include 
      - operation: keep_columns
        columns: {{conformed_columns}}
  {% endfor %}

  # JOIN DATA TOGETHER FOR FUTURE TRANSFORMATIONS
  stacked_objective_assessment_scores:
    source: $transformations.cli_circle_scores_rapid_vocabulary_v1_rv_set1_v1
    operations:
      - operation: union
        sources:
  {% for objective_assessment in objective_assessments %}
          - $transformations.cli_circle_scores_{{ objective_assessment }}
  {% endfor %}

  # JOIN DATA TOGETHER FOR FUTURE TRANSFORMATIONS
  stacked_all_assessment_scores:
    source: $transformations.stacked_assessment_scores
    operations:
      - operation: union
        sources:
          - $transformations.stacked_objective_assessment_scores


destinations:
  studentAssessments:
    source: $transformations.stacked_objective_assessment_scores
    template: assessments/CLI_Circle/templates/test_variable_2.jsont
    extension: csv
    linearize: True
    debug: True
    show_progress: True