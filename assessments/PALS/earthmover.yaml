version: 2
config:
  output_dir: ${OUTPUT_DIR}
  memory_limit: 1GB
  state_file: ./runs.csv
  show_graph: False
  show_stacktrace: true
  parameter_defaults:
    STUDENT_ID_NAME: 'edFi_studentUniqueID' # default to the column added by the apply_xwalk package of student ID xwalking feature edFi_studentUniqueID
    POSSIBLE_STUDENT_ID_COLUMNS: 'STD_STI,ID'
    DESCRIPTOR_NAMESPACE: 'uri://ed-fi.org'

sources:
  input:
    file: ${INPUT_FILE}
    header_rows: 1
  assessments:
    file: ./seeds/assessments.csv
    header_rows: 1 
    debug: true
  assessmentReportingMethodDescriptors:
    file: ./seeds/assessmentReportingMethodDescriptors.csv
    header_rows: 1
  gradeLevelDescriptors:
    file: ./seeds/gradeLevelDescriptors.csv
    header_rows: 1
  assessmentPeriodDescriptors:
    file: ./seeds/assessmentPeriodDescriptors.csv
    header_rows: 1
  assessmentCategoryDescriptors:
    file: ./seeds/assessmentCategoryDescriptors.csv
    header_rows: 1
  
transformations:
  input:
    source: $sources.input
    operations: []

  reporting_methods:
    source: $sources.assessmentReportingMethodDescriptors
    operations:
      - operation: limit_rows
        count: 1

  grade_levels:
    source: $sources.gradeLevelDescriptors
    operations:
      - operation: limit_rows
        count: 1
  
  assessment_grade_level_descriptors:
    source: $sources.gradeLevelDescriptors
    operations:
      - operation: add_columns
        columns:
          grade_json: >
              {%raw-%}  
              {
                "gradeLevelDescriptor": "{{ namespace }}#{{codeValue}}"
              }
              {%-endraw%}
      - operation: modify_columns
        columns:
          grade_json: "{%raw%}{{grade_json | replace('\n', '')-}}{%endraw%}"
      - operation: group_by
        group_by_columns:
          - assessmentIdentifier
        create_columns: 
          grade_json: agg(grade_json,,)

  scores:
    source: $sources.assessmentReportingMethodDescriptors
    operations:
      - operation: add_columns
        columns:
          score_json: >  
              {%raw-%}  
              {
                "assessmentReportingMethodDescriptor": "{{ namespace }}#{{codeValue}}",
                "resultDatatypeTypeDescriptor": "${DESCRIPTOR_NAMESPACE}/ResultDatatypeTypeDescriptor#Integer",  
                "minimumScore":"{{ minimumScore }}",
                "maximumScore":"{{ maximumScore }}"                
              }
              {%-endraw%}
      - operation: modify_columns
        columns:
          score_json: "{%raw%}{{score_json | replace('\n', '')-}}{%endraw%}"
      - operation: group_by
        group_by_columns:
          - assessmentIdentifier
        create_columns: 
          score_json: agg(score_json,,)

  {% set assessment = ['NAMEWRI','ALPHA_UC','ALPHA_LC', 'LETTERSND', 'BEGSOUND', 'PRNTWORD', 'RHYME', 'NURRHYME'] %}
  
  {% for assessment_name in assessment %}
  period_{{assessment_name}}:
    source: $sources.assessmentPeriodDescriptors
    operations:
      - operation: add_columns
        columns:
          assessmentIdentifier: "PALS_{{assessment_name}}" 
      - operation: add_columns
        columns:
          period_json: >  
              {%raw-%}  
              {
                "assessmentPeriodDescriptor": "{{ namespace }}#{{codeValue}}"
              }
              {%-endraw%}
      - operation: modify_columns
        columns:
          period_json: "{%raw%}{{period_json | replace('\n', '')-}}{%endraw%}"
      - operation: group_by
        group_by_columns:
          - assessmentIdentifier
        create_columns: 
          period_json: agg(period_json,,)
      - operation: keep_columns 
        columns:
          - assessmentIdentifier
          - period_json 
         
      
  {% endfor %}

  combined_period_results:
    source: $transformations.period_{{ assessment[0] }}
    operations:
    - operation: union
      sources:
{% for assessment_name in assessment[1:] %}
        - $transformations.period_{{ assessment_name }}
{% endfor %}
    - operation: distinct_rows
      columns: 
        - assessmentIdentifier
        - period_json 
    

{% for assessment_name in assessment %}

  student_assessment_{{assessment_name}}:
    source: $transformations.input
    operations:
      - operation: keep_columns
        columns:
          - {{assessment_name}}
          - ${STUDENT_ID_NAME}
          - "SCH_NO"
          - "ASSESSDATE"
          - "YEAR"
          - "SEMESTER"
      - operation: date_format
        column: ASSESSDATE
        from_format: "%m/%d/%Y"
        to_format: "%Y-%m-%d"
      - operation: add_columns
        columns:
          assessmentIdentifier: "PALS_{{assessment_name}}" 
      - operation: duplicate_columns
        columns: 
          ${STUDENT_ID_NAME}: studentUniqueId
      - operation: rename_columns
        columns:
          SCH_NO: schoolId
      - operation: rename_columns
        columns:
          {{assessment_name}}: Score 
      - operation: duplicate_columns
        columns: 
          SEMESTER: assessmentPeriodDescriptor
      - operation: map_values
        column: assessmentPeriodDescriptor
        map_file: ./seeds/semester_mapping.csv
      - operation: add_columns
        columns:
          studentAssessmentIdentifier: "{% raw %}{{ md5(assessmentIdentifier ~ '-' ~ studentUniqueId ~ '-' ~  ASSESSDATE) }}{% endraw %}"
      - operation: add_columns
        columns:
          result: "{%raw-%}{{ Score }}{%-endraw%}"
      - operation: join
        sources:
          - $sources.assessments
        join_type: inner
        left_key: assessmentIdentifier
        right_key: assessmentIdentifier
      - operation: rename_columns
        columns:
          namespace: assessmentNamespace
      - operation: join
        sources:
          - $sources.assessmentReportingMethodDescriptors
        join_type: inner
        left_key: assessmentIdentifier
        right_key: assessmentIdentifier
      - operation: add_columns
        columns:
          administrationDate: "{%raw%}{{ ASSESSDATE }}{%endraw%}"
          whenAssessedGradeLevelDescriptor: "{%raw%}{{ whenAssessedGradeLevelDescriptor }}{%endraw%}"
          schoolYear: "{%raw%}{{ YEAR[-4:] }}{%endraw%}"
          descriptorNamespace:  ${DESCRIPTOR_NAMESPACE}
      - operation: keep_columns
        columns:
            - "studentAssessmentIdentifier"
            - "assessmentIdentifier"
            - "schoolId"
            - "schoolYear"
            - "studentUniqueId"
            - "administrationDate"
            - "descriptorNamespace"
            - "result"
            - "namespace"
            - "codeValue"
            - "whenAssessedGradeLevelDescriptor"
            - "assessmentPeriodDescriptor" 
            - "assessmentNamespace"
      - operation: filter_rows
        query: "result != 'NULL' and result!=''"
        behavior: include
  {% endfor %}

  combined_results:
    source: $transformations.student_assessment_{{ assessment[0] }}
    operations:
    - operation: union
      sources:
{% for assessment_name in assessment[1:] %}
        - $transformations.student_assessment_{{ assessment_name }}
{% endfor %}
  
  prepare_assessments:
    source: $sources.assessments
    operations:
      - operation: join
        sources:
          - $transformations.assessment_grade_level_descriptors
          - $transformations.scores
        join_type: inner
        left_key: assessmentIdentifier
        right_key: assessmentIdentifier
      - operation: join
        sources:
          - $transformations.combined_period_results
        join_type: inner
        left_key: assessmentIdentifier
        right_key: assessmentIdentifier
      - operation: add_columns
        columns:
          descriptorNamespace: ${DESCRIPTOR_NAMESPACE}

destinations:
  assessments:
    source: $transformations.prepare_assessments
    template: ./templates/assessments.jsont
    extension: jsonl

  assessmentReportingMethodDescriptors:
    #source: $sources.assessmentReportingMethodDescriptors
    source: $transformations.reporting_methods
    template: ./templates/descriptors.jsont
    extension: jsonl
    

  studentAssessments:
    source: $transformations.combined_results
    template: ./templates/studentAssessments.jsont
    extension: jsonl

  studentAssessmentEducationOrganizationAssociations:
    source: $transformations.combined_results
    template: ./templates/studentAssessmentEducationOrganizationAssociations.jsont
    extension: jsonl

  assessmentPeriodDescriptors:
    source: $sources.assessmentPeriodDescriptors
    template: ./templates/descriptors.jsont
    extension: jsonl

  assessmentCategoryDescriptors:
    source: $sources.assessmentCategoryDescriptors
    template: ./templates/descriptors.jsont
    extension: jsonl

  gradeLevelDescriptors:
    #source: $sources.gradeLevelDescriptors
    source: $transformations.grade_levels
    template: ./templates/descriptors.jsont
    extension: jsonl
  