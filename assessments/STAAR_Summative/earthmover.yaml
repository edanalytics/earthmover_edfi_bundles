# See accompanying README.md for details about this file.

config:
  log_level: DEBUG
  output_dir: ${OUTPUT_DIR} # this will be a parameter that is passed through from the command line, leave this as-is
  memory_limit: 1GB
  state_file: ./runs.csv
  show_graph: False
  parameter_defaults:
    # the following should be included in every template
    STUDENT_ID_JOIN_COLUMN: tx_unique_student_id
    STUDENT_ID_NAME: tx_unique_student_id
    STUDENT_ID_XWALK: ''




sources:
  # assessmentReportingMethodDescriptors:
  #   file: ${BUNDLE_DIR}/seeds/assessmentReportingMethodDescriptors.csv
  #   header_rows: 1
  # performanceLevelDescriptors:
  #   file: ${BUNDLE_DIR}/seeds/performanceLevelDescriptors.csv
  #   header_rows: 1
  # objectiveAssessments:
  #   file: ${BUNDLE_DIR}/seeds/objectiveAssessments.csv
  #   header_rows: 1
  # assessments:
  #   file: ${BUNDLE_DIR}/seeds/assessments.csv
  #   header_rows: 1

  staar_summative_input:
    file: ${STAAR_SUMMATIVE_INPUT_FILE}
    header_rows: 1
  staar_summative_alt_input:
    file: ${STAAR_SUMMATIVE_ALT_INPUT_FILE}
    header_rows: 1
  staar_summative_eoc_input:
    file: ${STAAR_SUMMATIVE_EOC_INPUT_FILE}
    header_rows: 1
  staar_summative_eoc_alt_input:
    file: ${STAAR_SUMMATIVE_EOC_ALT_INPUT_FILE}
    header_rows: 1

  student_id_xwalk:
    # This file only needs to be supplied if the source assessment file does not
    # contain the studentUniqueId used by Ed-Fi
    file: ${STUDENT_ID_XWALK}
    header_rows: 1
    columns:
      - from
      - to
    optional: True


transformations:
  staar_summative_alt_renamed:
    operations:
      - operation: rename_columns
        source: $sources.staar_summative_alt_input
        columns:
          # _5 is added by our python script bc there are duplicate colnames, 5 represents colindex in the file. later versions of this colname are for prev years
          "county_district_campus_number_5": county_district_campus_number
          # standardize score names so the loop below works
          "reading_reporting_category_1scores": reading_reporting_category_1_raw_score
          "reading_reporting_category_2scores": reading_reporting_category_2_raw_score
          "reading_reporting_category_3scores": reading_reporting_category_3_raw_score
          "mathematics_reporting_categoryscores_1": mathematics_reporting_category_1_raw_score
          "mathematics_reading_reportingcategory_2_scores": mathematics_reporting_category_2_raw_score
          "mathematics_reading_reportingcategory_3_scores": mathematics_reporting_category_3_raw_score
          "mathematics_reading_reportingcategory_4_scores": mathematics_reporting_category_4_raw_score
          "social_studies_reporting_categoryscores_1": social_studies_reporting_category_1_raw_score
          "social_studies_reporting_categoryscores_2": social_studies_reporting_category_2_raw_score
          "social_studies_reporting_categoryscores_3": social_studies_reporting_category_3_raw_score
          "social_studies_reporting_categoryscores_4": social_studies_reporting_category_4_raw_score
          "science_reporting_category_1scores": science_reporting_category_1_raw_score
          "science_reporting_category_2scores": science_reporting_category_2_raw_score
          "science_reporting_category_3scores": science_reporting_category_3_raw_score
          "science_reporting_category_4scores": science_reporting_category_4_raw_score
      - operation: add_columns
        source: $transformations.staar_summative_alt_renamed
        columns:
          assessment_indentifier: staar_summative_alt
          # empty category 4 column for subjects without it. will be removed in studentAssessments.jsont
          # TODO see if there's a better workaround for this
          reading_reporting_category_4_raw_score: ""

  # staar_summative_eoc_renamed:
  #   operations:
  #     - operation: rename_columns
  #       source: $sources.staar_summative_eoc_input
  #       columns:


  {% set subjects = ['reading', 'mathematics', 'social_studies', 'science']%}
  {% for subject in subjects %}
  staar_summative_alt_scores_{{subject}}:
    operations:
      - operation: keep_columns
        source: $transformations.staar_summative_alt_renamed
        columns:
          - tx_unique_student_id
          - assessment_indentifier
          - grade_level_code
          - administration_date
          - county_district_campus_number
          - fall_2021_tsds_peims_county_district_campus_number
          - {{subject}}_reporting_category_1_raw_score
          - {{subject}}_reporting_category_2_raw_score
          - {{subject}}_reporting_category_3_raw_score
          - {{subject}}_reporting_category_4_raw_score
          - {{subject}}_raw_score
          - {{subject}}_scale_score
          - {{subject}}_test_version
          - level_ii__satisfactory_academicperformance_in_{{subject}}
          - level_iii__accomplished_academicperformance_in_{{subject}}
          - test_result_id_{{subject}}
          - opportunity_key_{{subject}}
      - operation: rename_columns
        source: $transformations.staar_summative_alt_scores_{{subject}}
        columns:
          {{subject}}_reporting_category_1_raw_score: reporting_category_1_raw_score
          {{subject}}_reporting_category_2_raw_score: reporting_category_2_raw_score
          {{subject}}_reporting_category_3_raw_score: reporting_category_3_raw_score
          {{subject}}_reporting_category_4_raw_score: reporting_category_4_raw_score
          {{subject}}_raw_score: raw_score
          {{subject}}_scale_score: scale_score
          {{subject}}_test_version: test_version
          level_ii__satisfactory_academicperformance_in_{{subject}}: level_2_satisfactory_academic_performance
          level_iii__accomplished_academicperformance_in_{{subject}}: level_3_accomplished_academic_performance
          test_result_id_{{subject}}: test_result_id
          opportunity_key_{{subject}}: opportunity_key
      - operation: add_columns
        source: $transformations.staar_summative_alt_scores_{{subject}}
        columns:
          subject: {{subject}}
      - operation: filter_rows
        source: $transformations.staar_summative_alt_scores_{{subject}}
        query: opportunity_key != ''
        behavior: include
  
  {% endfor %}  

  stacked_scores:
    operations:
      - operation: union
        sources:
          {% for subject in subjects %}
          - $transformations.staar_summative_alt_scores_{{subject}}
          {% endfor %}

  studentAssessments:
    operations:
      - operation: join
        sources:
          - $transformations.stacked_scores
          - $sources.student_id_xwalk
        left_key: ${STUDENT_ID_JOIN_COLUMN}
        right_key: from
        join_type: left
      - operation: duplicate_columns
        source: $transformations.studentAssessments
        columns:
          ${STUDENT_ID_NAME}: studentUniqueId
      # reformat test date from m/d/Y to Y-m-d
      # - operation: date_format
      #   source: $transformations.studentAssessments
      #   column: administration_date
      #   from_format: "%m%Y"
      #   to_format: "%Y-%m-%d"
      # add api_year as a passed-in env var
      - operation: add_columns
        source: $transformations.studentAssessments
        columns:
          api_year: ${API_YEAR} #NOTE, this is passed by the user/airflow as an env variable

  # TODO: remove this if not necessary and create additional transformations for other bootstrap if necessary

  ## sometimes it is necessary/helpful to create the objective assessment/other bootstrap data from the
  ## student assessment data itself, so the source for this could be a pre-created bootstrap file,
  ## the original student assessment file, or an above transformation
  # objective_assessments:
  #   operations:
  #     - operation: distinct_rows # TODO: this is just an example, add operations as necessary
  #       source: $transformations. # TODO: this depends, read comment above

# TODO: add/remove as needed
destinations:
  # objectiveAssessments:
  #   source: $transformations.objective_assessments
  #   template: ${BUNDLE_DIR}/templates/objectiveAssessments.jsont
  #   extension: jsonl
  #   linearize: True
  studentAssessments:
    source: $transformations.studentAssessments
    template: ${BUNDLE_DIR}/templates/studentAssessment.jsont
    extension: jsonl
    linearize: True