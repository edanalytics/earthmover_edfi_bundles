version: 2


config:
  log_level: INFO
  output_dir: ${OUTPUT_DIR}
  memory_limit: 1GB
  # state_file: state.csv
  show_graph: False
  show_stacktrace: true
  parameter_defaults:
    # STUDENT_ID_NAME: 'edFi_studentUniqueID' # default to the column added by the apply_xwalk package of student ID xwalking feature
    STUDENT_ID_NAME: MOSIS_STATE_ID
    POSSIBLE_STUDENT_ID_COLUMNS: MOSIS_STATE_ID,DISTRICT_STUDENT_NUMBER,STUDENT_NUMBER
    DESCRIPTOR_NAMESPACE: uri://ed-fi.org
    EDFI_DS_VERSION: 5
    OUTPUT_DIR: output

sources:
  assessments:
    file: ./seeds/assessments.csv
    header_rows: 1
  assessmentReportingMethodDescriptors:
    file: ./seeds/assessmentReportingMethodDescriptors.csv
    header_rows: 1
  objectiveAssessments:
    file: ./seeds/objectiveAssessments.csv
    header_rows: 1
  performanceLevelDescriptors:
    file: ./seeds/performanceLevelDescriptors.csv
    header_rows: 1
  gradeLevelDescriptors:
    file: ./seeds/gradeLevelDescriptors.csv
    header_rows: 1

  input:
    # file: ${INPUT_FILE}
    file: ./data/sample_anonymized_student_test__small.tsv
    header_rows: 1

transformations:
  input:
    source: $sources.input
    operations: []

  clean_results:
    source: $transformations.input
    operations:
      - operation: modify_columns
        columns:
          "*": "{%raw%}{{ value | trim }}{%endraw%}"

      - operation: duplicate_columns
        columns:
          ${STUDENT_ID_NAME}: studentUniqueId


      # TODO: Map CONTENT_AREAs to SubjectDescriptor
      - operation: map_values
        column: CONTENT_AREA
        mapping:
          Eng. Language Arts: english_language_arts
          Mathematics: math
          Science: science
          Social Studies: social_studies

      - operation: date_format
        column: TEST_DATE
        from_format: "%m%d%y"
        to_format: "%Y-%m-%d"

      - operation: rename_columns
        columns:
          TEST_DATE: administrationDate

      - operation: add_columns
        columns:
          assessmentIdentifier: "fake_math_assessment"
          namespace: "uri://fakeassessmentvendor.com"

      - operation: combine_columns
        columns:
          - studentUniqueId
          - assessmentIdentifier
          - administrationDate
        new_column: studentAssessmentIdentifier
        separator: '-'

      - operation: modify_columns
        columns:
          studentAssessmentIdentifier: "{%raw%}{{ md5(studentAssessmentIdentifier) }}{%endraw%}"
      # - operation: join
      #   sources:
      #     - $sources.gradeLevelDescriptors
      #   join_type: inner
      #   # change this to match the grade from the file
      #   left_keys:
      #     - grade
      #     - assessmentIdentifier
      #   right_keys:
      #     - originalGrade
      #     - assessmentIdentifier

  # instead of hardcoding descriptors that typically use ed-fi defaults (like subjects/grades)
  # we list those in a csv and aggregate as a transformation so we never hardcode those in the jsont
  grade_level_descriptors:
    source: $sources.gradeLevelDescriptors
    operations:
      - operation: add_columns
        columns:
          grade_json: >
            {%raw-%}
            {
              "gradeLevelDescriptor": "{{gradeLevelDescriptor}}"
            },
            {%-endraw%}
      - operation: modify_columns
        columns:
          grade_json: "{%raw%}{{grade_json | replace('\n', '')-}}{%endraw%}"
      # group and aggregate:
      - operation: group_by
        group_by_columns:
          - assessmentIdentifier
        create_columns:
          grade_json: agg(grade_json,)
      # there will be a trailing comma, want to get rid of that
      - operation: modify_columns
        columns:
          grade_json: "{%raw%}{{value.rstrip().rstrip(',')}}{%endraw%}"

  assessments:
    source: $sources.assessments
    operations:
      - operation: join
        sources:
          - $transformations.grade_level_descriptors
        join_type: inner
        left_key: assessmentIdentifier
        right_key: assessmentIdentifier

destinations:
  clean_results:
    source: $transformations.clean_results
    template: ./templates/studentAssessments.jsont
    extension: jsonl

  # assessments:
  #   source: $transformations.assessments
  #   template: ./templates/assessments.jsont
  #   extension: jsonl
  # assessmentReportingMethodDescriptors:
  #   source: $sources.assessmentReportingMethodDescriptors
  #   template: ./templates/descriptors.jsont
  #   extension: jsonl
  # performanceLevelDescriptors:
  #   source: $sources.performanceLevelDescriptors
  #   template: ./templates/descriptors.jsont
  #   extension: jsonl
  # objectiveAssessments:
  #   source: $sources.objectiveAssessments
  #   template: ./templates/objectiveAssessments.jsont
  #   extension: jsonl
  # studentAssessments:
  #   source: $transformations.clean_results
  #   template: ./templates/studentAssessments.jsont
  #   extension: jsonl
