config:
  log_level: DEBUG
  output_dir: ${OUTPUT_DIR}
  memory_limit: 1GB
  state_file: ${STATE_FILE}
  show_graph: True
  show_stacktrace: True


sources:
  assessmentReportingMethodDescriptors:
    file: ${BUNDLE_DIR}/seeds/assessmentReportingMethodDescriptors.csv
    header_rows: 1
  performanceLevelDescriptors:
    file: ${BUNDLE_DIR}/seeds/performanceLevelDescriptors.csv
    header_rows: 1
  objectiveAssessments:
    file: ${BUNDLE_DIR}/seeds/objectiveAssessments.csv
    header_rows: 1
  assessments:
    file: ${BUNDLE_DIR}/seeds/assessments.csv
    header_rows: 1
  scready_input:
    file: ${INPUT_FILE}
    type: sas
    encoding: latin-1

transformations:
  scready_student_assessment:
    operations:
      - operation: keep_columns 
        source: $sources.scready_input
        columns: 
          - StateID
          - SchoolID
          - ELAGrade
          - ELASS
          - ELAVSS
          - ELALev
          - ELALev1 
          - ELALev2
          - ELALev3
          - ELALev4
          - ELALev5
          - ELALev6
          - ELALev7
          - ELALev8
          - ELALev9
          - ELALev11
          - MathGrade
          - MathSS
          - MathVSS
          - MathLev
          - MathLev1
          - MathLev2
          - MathLev3
          - MathLev4
          - MathLev5
      - operation: rename_columns
        source: $transformations.scready_student_assessment
        columns:
          StateID: student_unique_id
      - operation: add_columns
        source: $transformations.scready_student_assessment
        columns:
          school_year:  ${API_YEAR}
          administration_date: {{ ${API_YEAR} ~ "-05-15" }} 
      - operation: filter_rows
        source: $transformations.scready_student_assessment
        query: student_unique_id.notnull()
        behavior: include
  scready_student_assessment_ela:
    operations:
      - operation: modify_columns 
        source: $transformations.scready_student_assessment
        columns: 
          MathLev: ''
          MathLev1: ''
          MathLev2: ''
          MathLev3: ''
          MathLev4: ''
          MathLev5: ''
          MathVSS: ''
          MathSS: ''
      - operation: add_columns 
        source: $transformations.scready_student_assessment_ela
        columns: 
          subject: 'English Language Arts'
          student_grade: "{%raw%}{{ELAGrade}}{%endraw%}"
  scready_student_assessment_math:
    operations:
      - operation: modify_columns 
        source: $transformations.scready_student_assessment
        columns: 
          ELALev: ''
          ELALev1: ''
          ELALev2: ''
          ELALev3: ''
          ELALev4: ''
          ELALev5: ''
          ELALev6: ''
          ELALev7: ''
          ELALev8: ''
          ELALev9: ''
          ELALev11: ''
          ELAVSS: ''
          ELASS: ''
      - operation: add_columns 
        source: $transformations.scready_student_assessment_math
        columns: 
          subject: 'Mathematics'
          student_grade: "{%raw%}{{MathGrade}}{%endraw%}"
  scready_student_assessment_stacked: 
    operations: 
      - operation: union 
        sources: 
          - $transformations.scready_student_assessment_ela
          - $transformations.scready_student_assessment_math
      - operation: add_columns
        source: $transformations.scready_student_assessment_stacked
        columns:
          student_assessment_id: "{%raw%}{{student_unique_id}}_{{subject}}_{{school_year}}{%endraw%}"
      - operation: map_values
        source: $transformations.scready_student_assessment_stacked
        column: student_grade
        map_file: ${BUNDLE_DIR}/seeds/grade_mapping.csv
    
destinations:
  assessments:
    source: $sources.assessments
    template: ${BUNDLE_DIR}/templates/assessments.jsont
    extension: jsonl
    linearize: True
  objectiveAssessments:
    source: $sources.objectiveAssessments
    template: ${BUNDLE_DIR}/templates/objectiveAssessments.jsont
    extension: jsonl
    linearize: True
  performanceLevelDescriptors:
    source: $sources.performanceLevelDescriptors
    template: ${BUNDLE_DIR}/templates/performanceLevelDescriptors.jsont
    extension: jsonl
    linearize: True
  assessmentReportingMethodDescriptors:
    source: $sources.assessmentReportingMethodDescriptors
    template: ${BUNDLE_DIR}/templates/assessmentReportingMethodDescriptors.jsont
    extension: jsonl
    linearize: True
  studentAssessments:
    source: $transformations.scready_student_assessment_stacked
    template: ${BUNDLE_DIR}/templates/studentAssessments.jsont
    extension: jsonl
    linearize: True
