# See accompanying README.md for details about this file.
version: 2

config:
  log_level: DEBUG
  output_dir:  ${OUTPUT_DIR} # this will be a parameter that is passed through from the command line, leave this as-is.
  memory_limit: 1GB
  state_file: ./runs.csv
  show_graph: False

sources:
  cli_tx_kea_input:
    file: ${INPUT_FILE}
    header_rows: 3

  assessmentReportingMethodDescriptors:
    file: ${BUNDLE_DIR}/seeds/assessmentReportingMethodDescriptors.csv
    header_rows: 1

  assessments:
    file: ${BUNDLE_DIR}/seeds/assessments.csv
    header_rows: 1

  objectiveAssessments:
    file: ${BUNDLE_DIR}/seeds/objectiveAssessments.csv
    header_rows: 1

# PREP-STEP 1: CREATE A LIST OF COLUMNS TO STACK VERTICALLY.
# The CLI TX-KEA Data arrives in a wide format with each row representing a single student. To use this data in our templates, we need to pivot the table into a long format.
# This involves standardizing the column titles of subject/objective assessments (e.g., "txkea_letter_names") to generic titles (e.g., "subject_name").
# The objective is to stack these conformed columns so that one row represents a student/subject assessed.
# This list will be used in our final "keep columns" step, to indicate the conformed columns we want to retain in the final transformation.
{% set conformed_columns = [
  'wave',
  'student_wave_id', 
  'local_student_id',
  'student_state_id',
  'school_year',
  'subject_name',
  'subject_descriptor', 
  'subject_assessment_type',
  'subject_score',
  'subject_cut_point',
  'subject_date',  
  'oa_category_1_name',
  'oa_category_2_name',
  'oa_category_3_name',
  'oa_category_4_name',
  'oa_category_5_name',
  'oa_category_6_name',
  'oa_category_1_descriptor',
  'oa_category_2_descriptor',
  'oa_category_3_descriptor',
  'oa_category_4_descriptor',
  'oa_category_5_descriptor',
  'oa_category_6_descriptor',
  'oa_category_1_date',
  'oa_category_2_date',
  'oa_category_3_date',
  'oa_category_4_date',
  'oa_category_5_date',
  'oa_category_6_date',
  'oa_category_1_score',
  'oa_category_2_score',
  'oa_category_3_score',
  'oa_category_4_score',
  'oa_category_5_score',
  'oa_category_6_score',
  'oa_category_1_cut_point',
  'oa_category_2_cut_point',
  'oa_category_3_cut_point',
  'oa_category_4_cut_point',
  'oa_category_5_cut_point',
  'oa_category_6_cut_point',
  'screener_assess_ref_1_name',
  'screener_assess_ref_2_name',
  'screener_assess_ref_3_name',
  'screener_assess_ref_1_descriptor',
  'screener_assess_ref_2_descriptor',
  'screener_assess_ref_3_descriptor',
  'screener_assess_ref_1_score',
  'screener_assess_ref_2_score',
  'screener_assess_ref_3_score',
  'composite_assess_ref_1_name',
  'composite_assess_ref_2_name',
  'composite_assess_ref_3_name',
  'composite_assess_ref_1_descriptor',
  'composite_assess_ref_2_descriptor',
  'composite_assess_ref_3_descriptor',
  'composite_assess_ref_1_score',
  'composite_assess_ref_2_score',
  'composite_assess_ref_3_score'
  ] 
%}


# PREP-STEP 2: CREATE A DICTIONARY OF SUBJECTS AND OBJECTIVE ASSESSMENTS TO CONFORM AND STACK.
# We need this comprehensive dictionary to pass on values to our conformed columns above.
# In CLI TX-KEA data, the subject column names vary between English and Spanish assessments.
# For example, "txkea_letter_names" is used for English assessments, while "txkea_letter_names_sp" is used for Spanish assessments.
# To handle these distinctions, we create two distinct dictionaries, which eventually merge to undergo the final transformations.

# An output eventually created by this dictionary would look like:
  # student_id | subject_name | subject_descriptor    | ...subject_cut_point   | subject_wave_1_subtest_1_name       | ...subject_wave_1_subtest_1_score
  # 1234       | pa_v2        | Phonological Awareness| ...Support             | txkea_letter_names                  | ...10
  # 1234       | math_v1      | Math                  | ...On Track            | txkea_blending                      | ...80

{% set subjects = {
    'txkea_dyslexia_checklist': {
      'subject_name_spa': 'txkea_dyslexia_checklist_sp',
      'colname': 'txkea_dyslexia_checklist',
      'descriptor': 'KG Dyslexia Referral Checklist',
      'subject_assess_type':'checklist',
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'kea_dyslexia_screener': {
      'subject_name_spa': 'kea_dyslexia_screener_sp',
      'colname': 'kea_dyslexia_screener',
      'descriptor': 'Dyslexia Screener',
      'subject_assess_type':'screener',
      'subject_assessments': [
        {'subject_assess_ref_1':[{'subject_asses_ref_colname':'txkea_letter_sounds', 'subject_asses_ref_colname_spa':'txkea_letter_sounds_sp', 'subject_asses_ref_descriptor':'Letter Sounds'}]},
        {'subject_assess_ref_2':[{'subject_asses_ref_colname':'txkea_blending', 'subject_asses_ref_colname_spa':'txkea_blending_sp', 'subject_asses_ref_descriptor':'Blending'}]},
        {'subject_assess_ref_3':[{'subject_asses_ref_colname_spa':'txkea_decoding_3_sp', 'subject_asses_ref_descriptor':'Decoding'}]}
      ],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': False
    },
    'kea_literacy_screening': {
      'subject_name_spa': 'kea_literacy_screening_sp',
      'colname': 'kea_literacy_screening',
      'descriptor': 'Literacy Screening',
      'subject_assess_type':'screener',
      'subject_assessments': [
        {'subject_assess_ref_1':[{'subject_asses_ref_colname':'txkea_vocabulary_1', 'subject_asses_ref_colname_spa':'txkea_vocabulary_1_sp', 'subject_asses_ref_descriptor':'Vocabulary Wave 1'}]},
        {'subject_assess_ref_2':[{'subject_asses_ref_colname':'txkea_letter_names_1', 'subject_asses_ref_colname_spa':'txkea_letter_names_sp', 'subject_asses_ref_descriptor':'Letter Names Wave 1'}]},
        {'subject_assess_ref_3':[{'subject_asses_ref_colname':'txkea_spelling_1', 'subject_asses_ref_colname_spa':'txkea_spelling_1_sp', 'subject_asses_ref_descriptor':'Spelling Wave 1'}]}
      ],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': False
    },
    'txkea_literacy_reading_composite': {
      'subject_name_spa': 'txkea_literacy_reading_composite_sp',
      'colname': 'txkea_literacy_reading_composite',
      'descriptor': 'Literacy Reading Composite',
      'subject_assess_type':'composite',
      'subject_assessments': [
        {'subject_assess_ref_1':[{'subject_asses_ref_colname':'txkea_letter_names_1', 'subject_asses_ref_colname_spa': 'txkea_letter_names_sp', 'subject_asses_ref_descriptor':'Letter Names Wave 1'}]},
        {'subject_assess_ref_2':[{'subject_asses_ref_colname':'txkea_letter_sounds_1', 'subject_asses_ref_colname_spa': 'txkea_letter_sounds_sp', 'subject_asses_ref_descriptor':'Letter Sounds 1'}]},
        {'subject_assess_ref_3':[{'subject_asses_ref_colname':'txkea_blending_1', 'subject_asses_ref_colname_spa': 'txkea_blending_1_sp', 'subject_asses_ref_descriptor':'Blending 1'}]}
      ],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': False
    },
    'txkea_language_composite': {
      'subject_name_spa': 'txkea_language_composite_sp',
      'colname': 'txkea_language_composite',
      'descriptor': 'Language Composite',
      'subject_assess_type':'composite',
      'subject_assessments': [
        {'subject_assess_ref_1':[{'subject_asses_ref_colname':'txkea_vocabulary_1', 'subject_asses_ref_colname_spa': 'txkea_vocabulary_1_sp', 'subject_asses_ref_descriptor':'Vocabulary Wave 1'}]},
        {'subject_assess_ref_2':[{'subject_asses_ref_colname':'txkea_listening_comp_1', 'subject_asses_ref_colname_spa': 'txkea_listening_comp_1_sp', 'subject_asses_ref_descriptor':'Listening Comprehension 1'}]}
      ],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': False
    },
    'txkea_letter_names': {
      'subject_name_spa': 'txkea_letter_names_sp',
      'colname': 'txkea_letter_names',
      'descriptor': 'Letter Names',
      'subject_assess_type':'subject',
      'objective_assessments':[],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_spelling': {
      'subject_name_spa': 'txkea_spelling_sp',
      'colname': 'txkea_spelling',
      'descriptor': 'Spelling',
      'subject_assess_type':'subject',
      'objective_assessments':[],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_listening_comp': { 
      'subject_name_spa': 'txkea_listening_comp_sp',
      'colname': 'txkea_listening_comp',
      'descriptor': 'Listening Comp',
      'subject_assess_type':'subject',
      'objective_assessments':[
        {'oa_category_1':{'colname':'txkea_listening_comp_txkea_listening_comp_2_receptive', 'colname_spa':'txkea_listening_comp_sp_txkea_listening_comp_2_receptive_sp', 'descriptor':'Listening Comp 2 Receptive', 'has_cp_col': False}}, 
        {'oa_category_2':{'colname':'txkea_listening_comp_txkea_listening_comp_2_expressive', 'colname_spa':'txkea_listening_comp_sp_txkea_listening_comp_2_expressive_sp', 'descriptor':'Listening Comp 2 Expressive', 'has_cp_col': False}}, 
        {'oa_category_3':{'colname':'txkea_listening_comp_txkea_listening_comprehension_3_receptive', 'colname_spa':'txkea_listening_comp_sp_txkea_listening_comprehension_3_receptive_sp', 'descriptor':'Listening Comprehension 3 Receptive', 'has_cp_col': True}}, 
        {'oa_category_4':{'colname':'txkea_listening_comp_txkea_listening_comprehension_3_expressive', 'colname_spa':'txkea_listening_comp_sp_txkea_listening_comprehension_3_expressive_sp', 'descriptor':'Listening Comprehension 3 Expressive - Dropped', 'has_cp_col': False}}
      ],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_vocabulary': {
      'subject_name_spa': 'txkea_vocabulary_sp',
      'colname': 'txkea_vocabulary',
      'descriptor': 'Vocabulary',
      'subject_assess_type':'subject',
      'objective_assessments':[],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_decoding': {
      'subject_name_spa': 'txkea_decoding_sp',
      'colname': 'txkea_decoding',
      'descriptor': 'Decoding',
      'subject_assess_type':'subject',
      'objective_assessments':[],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_letter_sounds': { 
      'subject_name_spa': 'txkea_letter_sounds_sp',
      'colname': 'txkea_letter_sounds',
      'descriptor': 'Letter Sounds',
      'subject_assess_type':'subject',
      'objective_assessments':[
        {'oa_category_1':{'colname':'txkea_letter_sounds_txkea_letter_sounds_2_receptive', 'descriptor':'Letter Sounds 2 Receptive', 'has_cp_col': False}}, 
        {'oa_category_2':{'colname':'txkea_letter_sounds_txkea_letter_sounds_2_expressive', 'descriptor':'Letter Sounds 2 Expressive', 'has_cp_col': False}}, 
        {'oa_category_3':{'colname':'txkea_letter_sounds_txkea_letter_sounds_3_receptive', 'descriptor':'Letter Sounds 3 Receptive', 'has_cp_col': False}}, 
        {'oa_category_4':{'colname':'txkea_letter_sounds_txkea_letter_sounds_3_expressive', 'descriptor':'Letter Sounds 3 Expressive', 'has_cp_col': False}}
      ],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_blending': {
      'subject_name_spa': 'txkea_blending_sp',
      'colname': 'txkea_blending',
      'descriptor': 'Blending',
      'subject_assess_type':'subject',
      'objective_assessments':[
        {'oa_category_1':{'colname_spa':'txkea_blending_sp_txkea_blending_2_expressive_sp', 'descriptor':'Blending 2 Expressive', 'has_cp_col': False}}, 
        {'oa_category_2':{'colname_spa':'txkea_blending_sp_txkea_blending_2_receptive_sp', 'descriptor':'Blending 2 Receptive', 'has_cp_col': False}}, 
        {'oa_category_3':{'colname':'txkea_blending_txkea_blending_3_receptive', 'colname_spa':'txkea_blending_sp_txkea_blending_3_receptive_sp', 'descriptor':'Blending 3 Receptive', 'has_cp_col': False}}, 
        {'oa_category_4':{'colname':'txkea_blending_txkea_blending_3_expressive', 'colname_spa':'txkea_blending_sp_txkea_blending_3_expressive_sp', 'descriptor':'Blending 3 Expressive', 'has_cp_col': False}}
      ],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_math': {
      'subject_name_spa': 'txkea_math_sp',
      'colname': 'txkea_math',
      'descriptor': 'Math',
      'subject_assess_type':'subject',
      'objective_assessments':[
        {'oa_category_1':{'colname':'txkea_math_txkea_math_part_1', 'colname_spa':'txkea_math_sp_txkea_math_part_1_sp', 'descriptor':'Math Part 1', 'has_cp_col': False}}, 
        {'oa_category_2':{'colname':'txkea_math_txkea_math_part_2', 'colname_spa':'txkea_math_sp_txkea_math_part_2_sp', 'descriptor':'Math Part 2', 'has_cp_col': False}}, 
        {'oa_category_3':{'colname':'txkea_math_txkea_math_part_1_w2', 'colname_spa':'txkea_math_sp_txkea_math_part_1_w2_sp', 'descriptor':'Math Part 1 W2', 'has_cp_col': False}}, 
        {'oa_category_4':{'colname':'txkea_math_txkea_math_part_2_w2', 'colname_spa':'txkea_math_sp_txkea_math_part_2_w2_sp', 'descriptor':'Math Part 2 W2', 'has_cp_col': False}},
        {'oa_category_5':{'colname':'txkea_math_txkea_math_part_1_w3', 'colname_spa':'txkea_math_sp_txkea_math_part_1_w3_sp', 'descriptor':'Math Part 1 W3', 'has_cp_col': False}},
        {'oa_category_6':{'colname':'txkea_math_txkea_math_part_2_w3', 'colname_spa':'txkea_math_sp_txkea_math_part_2_w3_sp', 'descriptor':'Math Part 2 W3', 'has_cp_col': False}}
      ],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_science': {
      'subject_name_spa': 'txkea_science_sp',
      'colname': 'txkea_science',
      'descriptor': 'Science',
      'subject_assess_type':'subject',
      'objective_assessments':[],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_social_emotional': {
      'subject_name_spa': 'txkea_social_emotional_sp',
      'colname': 'txkea_social_emotional',
      'descriptor': 'Social Emotional Competence',
      'subject_assess_type':'subject',
      'objective_assessments':[],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_emotional_management': {
      'subject_name_spa': 'txkea_emotional_management_sp',
      'colname': 'txkea_emotional_management',
      'descriptor': 'Emotion Management',
      'subject_assess_type':'subject',
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_working_memory': {
      'subject_name_spa': 'txkea_working_memory_sp',
      'colname': 'txkea_working_memory',
      'descriptor': 'Working Memory',
      'subject_assess_type':'subject',
      'objective_assessments':[],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_inhibition': {
      'subject_name_spa': 'txkea_inhibition_sp',
      'colname': 'txkea_inhibition',
      'descriptor': 'Inhibition',
      'subject_assess_type':'subject',
      'objective_assessments':[],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_attention': {
      'subject_name_spa': 'txkea_attention_sp',
      'colname': 'txkea_attention',
      'descriptor': 'Attention',
      'subject_assess_type':'subject',
      'objective_assessments':[],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_academic_motor': {
      'subject_name_spa': 'txkea_academic_motor_sp',
      'colname': 'txkea_academic_motor',
      'descriptor': 'Academic Motor Skills',
      'subject_assess_type':'subject',
      'objective_assessments':[],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': True
    },
    'txkea_en_admin_mode': {
      'subject_name_spa': 'txkea_sp_admin_mode',
      'colname': 'txkea_en_admin_mode',
      'descriptor': 'Administration Mode',
      'subject_assess_type':'subject',
      'objective_assessments':[],
      'subject_assess_lang': ['English','Spanish'],
      'has_cp_col': False
    },
  }
%}


# TRANSFORMATION-STEP 1: CONVERT COLUMNS TO SNAKE CASE
# Certain columns in the data arrive with spaces or use "-" symbols instead of "_" as separators.
# For uniformity, we convert all columns to snake case before we begin working on the data. 

transformations:
  cli_tx_kea_student_assessment:
    source: $sources.cli_tx_kea_input
    operations:
      - operation: snake_case_columns 
      - operation: modify_columns
        columns:
          wave: "{%raw%}{{ wave |replace(' ', '_') }}{%endraw%}"
      - operation: add_columns
        columns:
          student_wave_id: '{%raw%}{{wave}}_{{school_year}}_{{student_engage_id}}{%endraw%}'


# TRANSFORMATION-STEP 2: ITERATE THROUGH SUBJECT DICTIONARY TO STANDARDIZE COLUMNS
# This loop creates the main subject columns in our conformed columns list.

{% for subject_name, subject_values in subjects.items() %}
  {% for assess_lang in subject_values.subject_assess_lang %}

    {% if assess_lang == 'English' %}
      {% set subject_colname = subject_name %}
      {% set subject_assess_lang = 'English' %}
    {% elif assess_lang == 'Spanish' %}
      {% set subject_colname = subject_values.subject_name_spa %}
      {% set subject_assess_lang = 'Spanish' %}
    {% endif %}

  cli_tx_kea_student_{{ subject_colname }}:
    source: $transformations.cli_tx_kea_student_assessment
    operations:
      - operation: rename_columns
        columns:
          {{ subject_colname }}: subject_score
          {{ subject_colname }}_date: subject_date

      - operation: add_columns
        columns:
          subject_name: {{ subject_values.colname }}
          subject_descriptor: {{ subject_values.descriptor }}
          subject_assessment_type: {{ assess_lang }}

      # Addressing subjects without a Cut Point column: -------------------------------------------------------------------
      # In cases where a cut point column is missing for a particular subject in the dataset,
      # we generate a null column named "subject_cut_point" to prevent any disruption of our "keep columns" transformation.

      {% if subject_values.has_cp_col %}
      - operation: rename_columns
        columns:
          cp_{{ subject_colname }}: subject_cut_point
      {% else %}
      - operation: add_columns
        columns:
          subject_cut_point: ''
      {% endif %}


    # Handling subjects with multiple Objective Assessments for student assessments:  ------------------------------------------------------------------------------
    # Certain subjects within CLI TX-KEA contain Objective Assessments ("Expressive" and "Receptive")
    # To capture this information, we introduce a "oa_category_x" column, indicating the objective on which a student was assessed.

        {% set cat_numbers=[] -%}

        {% for objective_assessment in subject_values.objective_assessments %}
          {% for oa_category, oa_values in objective_assessment.items() %}
            {% for oa_category, oa_values in objective_assessment.items() %}
            # Dealing with Spanish and English colname differences.
              {% if assess_lang == 'English' %}
                {% set oa_colname = oa_values.colname %}
              {% elif assess_lang == 'Spanish' %}
                {% set oa_colname = oa_values.colname_spa %}
              {% endif %}

              {% if oa_colname is not none and oa_colname | length %}
      # Creating basic columns for OAs.      
      - operation: rename_columns
        columns:
          {{ oa_colname }}: {{ oa_category }}_score
          {{ oa_colname }}_date: {{ oa_category }}_date    

      - operation: add_columns
        columns:
          {{ oa_category }}_name: {{oa_colname }}
          {{ oa_category }}_descriptor: {{ oa_values.descriptor }} 

      # In cases where a cut point column is missing for a particular OA in the dataset,
      # we generate a null column named "oa_category_x_cut_point" to prevent any disruption of our "keep columns" transformation.
            {% if subject_values.oa_has_cp_col %}
      - operation: rename_columns
        columns:
          cp_{{ oa_colname }}: {{ oa_category }}_cut_point
            {% else %}
      - operation: add_columns
        columns:
          {{ oa_category }}_cut_point: ''              
            {% endif %}

      # Append an empty record to our list above if a total of 7 OAs are not found on the subject record (need this for the keep columns operation).
      # This will let us construct the rest of the "oa_category_x" columns, so if "pa_v2" only has 4 objective assessments we append "1,2,3,4" to the empty cat_numbers list above
      # Then the code below will build the rest of the range for the numbers missing (e.g. "5,6,7")
          {% set cat_number = cat_numbers.append(oa_category.split('_')[-1]) %}   
              {% endif %}
            {% endfor %}
          {% endfor %}
        {% endfor %}

      # Create additional null columns if not found in the list for this subject (need this for the keep columns operation).
        {% for n in range(1, 7) %}
          {% if n|string not in cat_numbers %}
      - operation: add_columns
        columns:
          oa_category_{{ n }}_name: ''  
          oa_category_{{ n }}_descriptor: '' 
          oa_category_{{ n }}_date: '' 
          oa_category_{{ n }}_score: '' 
          oa_category_{{ n }}_cut_point: '' 
          {%- endif -%}      
        {%- endfor -%}


    # Handling screening and composite subject assessments:  ------------------------------------------------------------------------------
    # CLI TX-KEA contains screening and composite assessments - these assessments use combined values from other subjects to grade a student on a specific focus area:
      # kea_dyslexia_screener: Letter Sounds, Blending, Decoding.
      # kea_literacy_screening: Vocabulary 1, Letter Names, Spelling 1.
      # txkea_literacy_reading_composite: Letter Names, Letter Sounds, Blending 1.
      # txkea_language_composite: Vocabulary 1, Listenining Comp 1.
    # To capture this information, we introduce a "screener_assess_ref_x" and "screener_assess_ref_x" columns, indicating the subject, type, and subtest reference that builds the respective assessment.
    
    # Make sure the assessment type is either 'composite' or 'screener'
    {% if subject_values.subject_assess_type in ['composite', 'screener'] %}
      # If we are building this loop for "composite" types, then set remainder_subject_assess_type= 'screener' and viceversa.
      {% set remainder_subject_assess_type = (['composite', 'screener'] | reject("==", subject_values.subject_assess_type) | list ) %}
      {% set subject_assess_ref_numbers = [] %}
      {% for subject_assessments in subject_values.subject_assessments %}
        {% for subject_assess_ref, subject_assess_ref_values in subject_assessments.items() %}
          {% for subject_assess_item in subject_assess_ref_values%}
          # Dealing with Spanish and English colname differences.
            {% if assess_lang == 'English' %}
              {% set subject_assess_ref_values_colname = subject_assess_item.subject_asses_ref_colname %}
            {% elif assess_lang == 'Spanish' %}
              {% set subject_assess_ref_values_colname = subject_assess_item.subject_asses_ref_colname_spa %}
              {% set subject_assess_lang = 'Spanish' %}
            {% endif %}

            {% if subject_assess_ref_values_colname is not none and subject_assess_ref_values_colname | length %}
      # Creating basic columns for screener/composite subjects.
      - operation: rename_columns
        columns:
          {% set sa_n = subject_assess_ref.split('_')[-1] %}
          {{ subject_assess_ref_values_colname }}: {{subject_values.subject_assess_type}}_assess_ref_{{ sa_n }}_score
      - operation: add_columns
        columns:
          {{subject_values.subject_assess_type}}_assess_ref_{{ sa_n }}_name: {{ subject_assess_ref_values_colname }}
          {{subject_values.subject_assess_type}}_assess_ref_{{ sa_n }}_descriptor: {{ subject_assess_item.subject_asses_ref_descriptor }}

      {% set subject_assess_ref_append = subject_assess_ref_numbers.append(sa_n) %}
            {% endif %}
          {% endfor %}
        {% endfor %}
      {% endfor %}

      # Create additional null columns if not found in the dictionary for this subject (need this for the keep columns operation).
      {% for n in range(1, 4) %}
        {% if n|string not in subject_assess_ref_numbers %}
      - operation: add_columns
        columns:
          {{subject_values.subject_assess_type}}_assess_ref_{{ n }}_name: ''  
          {{subject_values.subject_assess_type}}_assess_ref_{{ n }}_descriptor: '' 
          {{subject_values.subject_assess_type}}_assess_ref_{{ n }}_score: ''  
        {%- endif -%}      
      {%- endfor %}
      
      # Create additional null columns for the remainder subject assessment type.
      {% for n in range(1, 4) %}
        {% for remainder_subject in remainder_subject_assess_type %}
      - operation: add_columns
        columns:
          {{ remainder_subject }}_assess_ref_{{ n }}_name: ''  
          {{ remainder_subject }}_assess_ref_{{ n }}_descriptor: '' 
          {{ remainder_subject }}_assess_ref_{{ n }}_score: ''          
        {% endfor %}
      {% endfor %}
      
    {% else %}
      # Create additional null columns for any other subject assessment type that is not 'composite' or 'screener'.
        {% for n in range(1, 4) %}
      - operation: add_columns
        columns:
          screener_assess_ref_{{ n }}_name: ''  
          screener_assess_ref_{{ n }}_descriptor: '' 
          screener_assess_ref_{{ n }}_score: ''  
          composite_assess_ref_{{ n }}_name: ''  
          composite_assess_ref_{{ n }}_descriptor: '' 
          composite_assess_ref_{{ n }}_score: ''           
        {%- endfor %}      
    {% endif %}

      # Filter out any data with empty scores and dates (so any rows that don't have a valid subject score taken).
      - operation: filter_rows
        query: subject_score != '' and subject_date != ''
        behavior: include 

      # Finally, we keep the conformed columns we need for the templates.
      - operation: keep_columns
        columns: {{conformed_columns}}

  {% endfor %}
{% endfor %}


# TRANSFORMATION-STEP 3: STACK ALL SUBJECT DATA TOGETHER
# Stack all the data we created together.
  stacked_subject_scores:
    source: $transformations.cli_tx_kea_student_txkea_dyslexia_checklist
    operations:
      - operation: union
        sources:
# To avoid duplicates, we remove txkea_dyslexia_checklist from this join (so we don't join txkea_dyslexia_checklist twice - once as a source above and as a joined table below)
{% for subject_name, subject_values in subjects.items() %}
  {% for assess_lang in subject_values.subject_assess_lang %}

    {% if assess_lang == 'English' %}
      {% set subject_colname = subject_name %}
    {% elif assess_lang == 'Spanish' %}
      {% set subject_colname = subject_values.subject_name_spa %}
    {% endif %}

    {% if subject_name != 'txkea_dyslexia_checklist' %}
          - $transformations.cli_tx_kea_student_{{ subject_colname }}
    {% endif %}  
  {% endfor %} 
{% endfor %} 

destinations:
  studentAssessments:
    source: $transformations.stacked_subject_scores
    template: ${BUNDLE_DIR}/templates/studentAssessments.jsont
    extension: jsonl

  objectiveAssessments:
    source: $sources.objectiveAssessments
    template: ${BUNDLE_DIR}/templates/objectiveAssessments.jsont
    extension: jsonl

  assessmentReportingMethodDescriptors:
    source: $sources.assessmentReportingMethodDescriptors
    template: ${BUNDLE_DIR}/templates/assessmentReportingMethodDescriptors.jsont
    extension: jsonl

  assessments:
    source: $sources.assessments
    template: ${BUNDLE_DIR}/templates/assessments.jsont
    extension: jsonl