# See accompanying README.md for details about this file.
version: 2

config:
  log_level: DEBUG
  output_dir: assessments/CLI_TX_KEA/output
  memory_limit: 1GB
  state_file: ./runs.csv
  show_graph: False
  parameter_defaults:
    STUDENT_ID_JOIN_COLUMN: student_engage_id

sources:
  cli_tx_kea_input:
    file: '/mnt/n/texas_esc_4/data/assessment/CLI TX-KEA/lamar_cisd/CircleDataExport_Texas Kindergarten Entry Assessment Results Export_20220720_210712210D80A/Report - deduped.csv'
    header_rows: 3

  assessmentReportingMethodDescriptors:
    file: assessments/CLI_TX_KEA/seeds/assessmentReportingMethodDescriptors.csv
    header_rows: 1

  assessments:
    file: assessments/CLI_TX_KEA/seeds/assessments.csv
    header_rows: 1

  objectiveAssessments:
    file: assessments/CLI_TX_KEA/seeds/objectiveAssessments.csv
    header_rows: 1

{% set conformed_columns = [
  'wave',
  'student_wave_id', 
  'school_year',
  'subject_name',
  'subject_descriptor', 
  'subject_assessment_type',
  'subject_score',
  'subject_cut_point',
  'subject_date',
  'subject_wave_1_subtest_1_number', 
  'subject_wave_1_subtest_2_number', 
  'subject_wave_2_subtest_1_number', 
  'subject_wave_2_subtest_2_number',  
  'subject_wave_3_subtest_1_number', 
  'subject_wave_3_subtest_2_number', 
  'subject_wave_1_subtest_1_name',   
  'subject_wave_1_subtest_2_name',   
  'subject_wave_2_subtest_1_name',
  'subject_wave_2_subtest_2_name',
  'subject_wave_3_subtest_1_name',  
  'subject_wave_3_subtest_2_name',  
  'subject_wave_1_subtest_1_descriptor', 
  'subject_wave_1_subtest_2_descriptor', 
  'subject_wave_2_subtest_1_descriptor',
  'subject_wave_2_subtest_2_descriptor',
  'subject_wave_3_subtest_1_descriptor',
  'subject_wave_3_subtest_2_descriptor',
  'subject_wave_1_subtest_1_date',
  'subject_wave_1_subtest_2_date',
  'subject_wave_2_subtest_1_date',
  'subject_wave_2_subtest_2_date',
  'subject_wave_3_subtest_1_date', 
  'subject_wave_3_subtest_2_date', 
  'subject_wave_1_subtest_1_score',
  'subject_wave_1_subtest_2_score',
  'subject_wave_2_subtest_1_score',
  'subject_wave_2_subtest_2_score',
  'subject_wave_3_subtest_1_score',
  'subject_wave_3_subtest_2_score',
  'subject_wave_1_subtest_1_cut_point',
  'subject_wave_1_subtest_2_cut_point',
  'subject_wave_2_subtest_1_cut_point',
  'subject_wave_2_subtest_2_cut_point',
  'subject_wave_3_subtest_1_cut_point',
  'subject_wave_3_subtest_2_cut_point',
  'subject_wave_1_subtest_1_module',
  'subject_wave_1_subtest_2_module',
  'subject_wave_2_subtest_1_module',
  'subject_wave_2_subtest_2_module',
  'subject_wave_3_subtest_1_module',
  'subject_wave_3_subtest_2_module',
  'screener_assess_ref_1_number',
  'screener_assess_ref_2_number',
  'screener_assess_ref_3_number',
  'screener_assess_ref_1_name',
  'screener_assess_ref_2_name',
  'screener_assess_ref_3_name',
  'screener_assess_ref_1_descriptor',
  'screener_assess_ref_2_descriptor',
  'screener_assess_ref_3_descriptor',
  'screener_assess_ref_1_score',
  'screener_assess_ref_2_score',
  'screener_assess_ref_3_score',
  'composite_assess_ref_1_number',
  'composite_assess_ref_2_number',
  'composite_assess_ref_3_number',
  'composite_assess_ref_1_name',
  'composite_assess_ref_2_name',
  'composite_assess_ref_3_name',
  'composite_assess_ref_1_descriptor',
  'composite_assess_ref_2_descriptor',
  'composite_assess_ref_3_descriptor',
  'composite_assess_ref_1_score',
  'composite_assess_ref_2_score',
  'composite_assess_ref_3_score'
  ] 
%}

{% set subjects_en = {
    'txkea_dyslexia_checklist': {
      'colname': 'txkea_dyslexia_checklist',
      'descriptor': 'KG Dyslexia Referral Checklist',
      'subject_assess_type':'checklist',
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'kea_dyslexia_screener': {
      'colname': 'kea_dyslexia_screener',
      'descriptor': 'Dyslexia Screener',
      'subject_assess_type':'screener',
      'subject_assessments': [
        {'subject_assess_ref_1':[{'subject_asses_ref_colname':'txkea_letter_sounds', 'subject_asses_ref_descriptor':'Letter Sounds'}]},
        {'subject_assess_ref_2':[{'subject_asses_ref_colname':'txkea_blending', 'subject_asses_ref_descriptor':'Blending'}]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': False
    },
    'kea_literacy_screening': {
      'colname': 'kea_literacy_screening',
      'descriptor': 'Literacy Screening',
      'subject_assess_type':'screener',
      'subject_assessments': [
        {'subject_assess_ref_1':[{'subject_asses_ref_colname':'txkea_vocabulary_1', 'subject_asses_ref_descriptor':'Vocabulary Wave 1'}]},
        {'subject_assess_ref_2':[{'subject_asses_ref_colname':'txkea_letter_names_1', 'subject_asses_ref_descriptor':'Letter Names Wave 1'}]},
        {'subject_assess_ref_3':[{'subject_asses_ref_colname':'txkea_spelling_1', 'subject_asses_ref_descriptor':'Spelling Wave 1'}]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': False
    },
    'txkea_literacy_reading_composite': {
      'colname': 'txkea_literacy_reading_composite',
      'descriptor': 'Literacy Reading Composite',
      'subject_assess_type':'composite',
      'subject_assessments': [
        {'subject_assess_ref_1':[{'subject_asses_ref_colname':'txkea_letter_names_1', 'subject_asses_ref_descriptor':'Letter Names Wave 1'}]},
        {'subject_assess_ref_2':[{'subject_asses_ref_colname':'txkea_letter_sounds_1', 'subject_asses_ref_descriptor':'Letter Sounds 1'}]},
        {'subject_assess_ref_3':[{'subject_asses_ref_colname':'txkea_blending_1', 'subject_asses_ref_descriptor':'Blending 1'}]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': False
    },
    'txkea_language_composite': {
      'colname': 'txkea_language_composite',
      'descriptor': 'Language Composite',
      'subject_assess_type':'composite',
      'subject_assessments': [
        {'subject_assess_ref_1':[{'subject_asses_ref_colname':'txkea_vocabulary_1', 'subject_asses_ref_descriptor':'Vocabulary Wave 1'}]},
        {'subject_assess_ref_2':[{'subject_asses_ref_colname':'txkea_listening_comp_1', 'subject_asses_ref_descriptor':'Listening Comprehension 1'}]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': False
    },
    'txkea_letter_names': {
      'colname': 'txkea_letter_names',
      'descriptor': 'Letter Names',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_letter_names_txkea_letter_names_1', 'descriptor':'Letter Names Wave 1', 'has_cp_col': True}]},
        {'wave_2':[{'colname':'txkea_letter_names_txkea_letter_names_2', 'descriptor':'Letter Names Wave 2', 'has_cp_col': True}]},
        {'wave_3':[{'colname':'txkea_letter_names_txkea_letter_names_3', 'descriptor':'Letter Names Wave 3', 'has_cp_col': True}]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_spelling': {
      'colname': 'txkea_spelling',
      'descriptor': 'Spelling',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_spelling_txkea_spelling_1', 'descriptor':'Spelling Wave 1', 'has_cp_col': True}]},
        {'wave_2':[{'colname':'txkea_spelling_txkea_spelling_2', 'descriptor':'Spelling Wave 2', 'has_cp_col': True}]},
        {'wave_3':[{'colname':'txkea_spelling_txkea_spelling_3', 'descriptor':'Spelling Wave 3', 'has_cp_col': True}]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_listening_comp': { 
      'colname': 'txkea_listening_comp',
      'descriptor': 'Listening Comp',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_listening_comp_txkea_listening_comp_1', 'descriptor':'Listening Comprehension 1', 'has_cp_col': True}]},
        {'wave_2':[
          {'colname':'txkea_listening_comp_txkea_listening_comp_2_receptive', 'descriptor':'Listening Comp 2 Receptive', 'module': 'Receptive', 'has_cp_col': False}, 
          {'colname':'txkea_listening_comp_txkea_listening_comp_2_expressive', 'descriptor':'Listening Comp 2 Expressive', 'module': 'Expressive', 'has_cp_col': False}
        ]},
        {'wave_3':[
          {'colname':'txkea_listening_comp_txkea_listening_comprehension_3_receptive', 'descriptor':'Listening Comprehension 3 Receptive', 'module': 'Receptive', 'has_cp_col': True},
          {'colname':'txkea_listening_comp_txkea_listening_comprehension_3_expressive', 'descriptor':'Listening Comprehension 3 Expressive - Dropped', 'module': 'Expressive', 'has_cp_col': False}
        ]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_vocabulary': {
      'colname': 'txkea_vocabulary',
      'descriptor': 'Vocabulary',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_vocabulary_txkea_vocabulary_1', 'descriptor':'Vocabulary Wave 1', 'has_cp_col': True}]},
        {'wave_2':[{'colname':'txkea_vocabulary_txkea_vocabulary_2', 'descriptor':'Vocabulary Wave 2', 'has_cp_col': True}]},
        {'wave_3':[{'colname':'txkea_vocabulary_txkea_vocabulary_3', 'descriptor':'Vocabulary Wave 3', 'has_cp_col': True}]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_decoding': {
      'colname': 'txkea_decoding',
      'descriptor': 'Decoding',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_decoding_txkea_decoding_1', 'descriptor':'Decoding Wave 1', 'has_cp_col': True}]},
        {'wave_2':[{'colname':'txkea_decoding_txkea_decoding_2', 'descriptor':'Decoding Wave 2', 'has_cp_col': True}]},
        {'wave_3':[{'colname':'txkea_decoding_txkea_decoding_3', 'descriptor':'Decoding Wave 3', 'has_cp_col': True}]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_letter_sounds': { 
      'colname': 'txkea_letter_sounds',
      'descriptor': 'Letter Sounds',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_letter_sounds_txkea_letter_sounds_1', 'descriptor':'Letter Sounds 1', 'has_cp_col': True}]},
        {'wave_2':[
          {'colname':'txkea_letter_sounds_txkea_letter_sounds_2_receptive', 'descriptor':'Letter Sounds 2 Receptive', 'module': 'Receptive', 'has_cp_col': False},
          {'colname':'txkea_letter_sounds_txkea_letter_sounds_2_expressive', 'descriptor':'Letter Sounds 2 Expressive', 'module': 'Expressive', 'has_cp_col': False}
          ]},
        {'wave_3':[
          {'colname':'txkea_letter_sounds_txkea_letter_sounds_3_receptive', 'descriptor':'Letter Sounds 3 Receptive', 'module': 'Receptive', 'has_cp_col': False},
          {'colname':'txkea_letter_sounds_txkea_letter_sounds_3_expressive', 'descriptor':'Letter Sounds 3 Expressive', 'module': 'Expressive', 'has_cp_col': False}
          ]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_blending': {
      'colname': 'txkea_blending',
      'descriptor': 'Blending',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_blending_txkea_blending_1', 'descriptor':'Blending 1', 'has_cp_col': True}]},
        {'wave_2':[{'colname':'txkea_blending_txkea_blending_2', 'descriptor':'Blending 2', 'has_cp_col': True}]},
        {'wave_3':[
          {'colname':'txkea_blending_txkea_blending_3_receptive', 'descriptor':'Blending 3 Receptive', 'module': 'Receptive', 'has_cp_col': False},
          {'colname':'txkea_blending_txkea_blending_3_expressive', 'descriptor':'Blending 3 Expressive', 'module': 'Expressive', 'has_cp_col': False}
        ]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_math': {
      'colname': 'txkea_math',
      'descriptor': 'Math',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[
          {'colname':'txkea_math_txkea_math_part_1', 'descriptor':'Math Part 1', 'module': 'Part 1', 'has_cp_col': False},
          {'colname':'txkea_math_txkea_math_part_2', 'descriptor':'Math Part 2', 'module': 'Part 2', 'has_cp_col': False},
        ]},
        {'wave_2':[
          {'colname':'txkea_math_txkea_math_part_1_w2', 'descriptor':'Math Part 1 W2', 'module': 'Part 1', 'has_cp_col': False},
          {'colname':'txkea_math_txkea_math_part_2_w2', 'descriptor':'Math Part 2 W2', 'module': 'Part 2', 'has_cp_col': False}
        ]},
        {'wave_3':[
          {'colname':'txkea_math_txkea_math_part_1_w3', 'descriptor':'Math Part 1 W3', 'module': 'Part 1', 'has_cp_col': False},
          {'colname':'txkea_math_txkea_math_part_2_w3', 'descriptor':'Math Part 2 W3', 'module': 'Part 2', 'has_cp_col': False}
        ]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_science': {
      'colname': 'txkea_science',
      'descriptor': 'Science',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_science_txkea_science_1', 'descriptor':'Science 1', 'has_cp_col': True}]},
        {'wave_2':[{'colname':'txkea_science_txkea_science_2', 'descriptor':'Science 2', 'has_cp_col': True}]},
        {'wave_3':[{'colname':'txkea_science_txkea_science_3', 'descriptor':'Science 3', 'has_cp_col': True}]}
      ],
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_social_emotional': {
      'colname': 'txkea_social_emotional',
      'descriptor': 'Social Emotional Competence',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_emotional_management': {
      'colname': 'txkea_emotional_management',
      'descriptor': 'Emotion Management',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_working_memory': {
      'colname': 'txkea_working_memory',
      'descriptor': 'Working Memory',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_inhibition': {
      'colname': 'txkea_inhibition',
      'descriptor': 'Inhibition',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_attention': {
      'colname': 'txkea_attention',
      'descriptor': 'Attention',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_academic_motor': {
      'colname': 'txkea_academic_motor',
      'descriptor': 'Academic Motor Skills',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'English',
      'has_cp_col': True
    },
    'txkea_en_admin_mode': {
      'colname': 'txkea_en_admin_mode',
      'descriptor': 'Administration Mode',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'English',
      'has_cp_col': False
    },
  }
%}

{% set subjects_spa = {
    'txkea_dyslexia_checklist_sp': {
      'colname': 'txkea_dyslexia_checklist',
      'descriptor': 'KG Dyslexia Referral Checklist',
      'subject_assess_type':'checklist',
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'kea_dyslexia_screener_sp': {
      'colname': 'kea_dyslexia_screener',
      'descriptor': 'Dyslexia Screener',
      'subject_assess_type':'screener',
      'subject_assessments': [
        {'subject_assess_ref_1':[{'subject_asses_ref_colname':'txkea_letter_sounds', 'subject_asses_ref_colname_spa': 'txkea_letter_sounds_sp', 'subject_asses_ref_descriptor':'Letter Sounds'}]},
        {'subject_assess_ref_2':[{'subject_asses_ref_colname':'txkea_blending', 'subject_asses_ref_colname_spa': 'txkea_blending_sp', 'subject_asses_ref_descriptor':'Blending'}]},
        {'subject_assess_ref_3':[{'subject_asses_ref_colname':'txkea_decoding', 'subject_asses_ref_colname_spa': 'txkea_decoding_3_sp', 'subject_asses_ref_descriptor':'Decoding'}]}
      ],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': False
    },
    'kea_literacy_screening_sp': {
      'colname': 'kea_literacy_screening',
      'descriptor': 'Literacy Screening',
      'subject_assess_type':'screener',
      'subject_assessments': [
        {'subject_assess_ref_1':[{'subject_asses_ref_colname':'txkea_vocabulary_1', 'subject_asses_ref_colname_spa': 'txkea_vocabulary_1_sp', 'subject_asses_ref_descriptor':'Vocabulary Wave 1'}]},
        {'subject_assess_ref_2':[{'subject_asses_ref_colname':'txkea_letter_names', 'subject_asses_ref_colname_spa': 'txkea_letter_names_sp', 'subject_asses_ref_descriptor':'Letter Names'}]},
        {'subject_assess_ref_3':[{'subject_asses_ref_colname':'txkea_spelling_1', 'subject_asses_ref_colname_spa': 'txkea_spelling_1_sp', 'subject_asses_ref_descriptor':'Spelling Wave 1'}]}
      ],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': False
    },
    'txkea_literacy_reading_composite_sp': {
      'colname': 'txkea_literacy_reading_composite',
      'descriptor': 'Literacy Reading Composite',
      'subject_assess_type':'composite',
      'subject_assessments': [
        {'subject_assess_ref_1':[{'subject_asses_ref_colname':'txkea_letter_names', 'subject_asses_ref_colname_spa': 'txkea_letter_names_sp', 'subject_asses_ref_descriptor':'Letter Names'}]},
        {'subject_assess_ref_2':[{'subject_asses_ref_colname':'txkea_letter_sounds', 'subject_asses_ref_colname_spa': 'txkea_letter_sounds_sp', 'subject_asses_ref_descriptor':'Letter Sounds'}]},
        {'subject_assess_ref_3':[{'subject_asses_ref_colname':'txkea_blending_1', 'subject_asses_ref_colname_spa': 'txkea_blending_1_sp', 'subject_asses_ref_descriptor':'Blending 1'}]}
      ],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': False
    },
    'txkea_language_composite_sp': {
      'colname': 'txkea_language_composite',
      'descriptor': 'Language Composite',
      'subject_assess_type':'composite',
      'subject_assessments': [
        {'subject_assess_ref_1':[{'subject_asses_ref_colname':'txkea_vocabulary_1', 'subject_asses_ref_colname_spa': 'txkea_vocabulary_1_sp', 'subject_asses_ref_descriptor':'Vocabulary Wave 1'}]},
        {'subject_assess_ref_2':[{'subject_asses_ref_colname':'txkea_listening_comp_1', 'subject_asses_ref_colname_spa': 'txkea_listening_comp_1_sp',  'subject_asses_ref_descriptor':'Listening Comprehension 1'}]}
      ],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': False
    },
    'txkea_letter_names_sp': {
      'colname': 'txkea_letter_names',
      'descriptor': 'Letter Names',
      'subject_assess_type':'subject',
      'waves':[],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_spelling_sp': {
      'colname': 'txkea_spelling',
      'descriptor': 'Spelling',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_spelling_txkea_spelling_1', 'colname_spa': 'txkea_spelling_sp_txkea_spelling_1_sp', 'descriptor':'Spelling Wave 1', 'has_cp_col': True}]},
        {'wave_2':[{'colname':'txkea_spelling_txkea_spelling_2', 'colname_spa': 'txkea_spelling_sp_txkea_spelling_2_sp', 'descriptor':'Spelling Wave 2', 'has_cp_col': True}]},
        {'wave_3':[{'colname':'txkea_spelling_txkea_spelling_3', 'colname_spa': 'txkea_spelling_sp_txkea_spelling_3_sp', 'descriptor':'Spelling Wave 3', 'has_cp_col': True}]}
      ],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_listening_comp_sp': { 
      'colname': 'txkea_listening_comp',
      'descriptor': 'Listening Comp',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_listening_comp_txkea_listening_comp_1', 'colname_spa': 'txkea_listening_comp_sp_txkea_listening_comp_1_sp', 'descriptor':'Listening Comprehension 1', 'has_cp_col': True}]},
        {'wave_2':[
          {'colname':'txkea_listening_comp_txkea_listening_comp_2_receptive', 'colname_spa': 'txkea_listening_comp_sp_txkea_listening_comp_2_receptive_sp', 'descriptor':'Listening Comp 2 Receptive', 'module': 'Receptive', 'has_cp_col': False}, 
          {'colname':'txkea_listening_comp_txkea_listening_comp_2_expressive', 'colname_spa': 'txkea_listening_comp_sp_txkea_listening_comp_2_expressive_sp', 'descriptor':'Listening Comp 2 Expressive', 'module': 'Expressive', 'has_cp_col': False}
        ]},
        {'wave_3':[
          {'colname':'txkea_listening_comp_txkea_listening_comprehension_3_receptive', 'colname_spa': 'txkea_listening_comp_sp_txkea_listening_comprehension_3_receptive_sp', 'descriptor':'Listening Comprehension 3 Receptive', 'module': 'Receptive', 'has_cp_col': True},
          {'colname':'txkea_listening_comp_txkea_listening_comprehension_3_expressive', 'colname_spa': 'txkea_listening_comp_sp_txkea_listening_comprehension_3_expressive_sp', 'descriptor':'Listening Comprehension 3 Expressive - Dropped', 'module': 'Expressive', 'has_cp_col': False}
        ]}
      ],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_vocabulary_sp': {
      'colname': 'txkea_vocabulary',
      'descriptor': 'Vocabulary',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_vocabulary_txkea_vocabulary_1', 'colname_spa': 'txkea_vocabulary_sp_txkea_vocabulary_1_sp', 'descriptor':'Vocabulary Wave 1', 'has_cp_col': True}]},
        {'wave_2':[{'colname':'txkea_vocabulary_txkea_vocabulary_2', 'colname_spa': 'txkea_vocabulary_sp_txkea_vocabulary_2_sp', 'descriptor':'Vocabulary Wave 2', 'has_cp_col': True}]},
        {'wave_3':[{'colname':'txkea_vocabulary_txkea_vocabulary_3', 'colname_spa': 'txkea_vocabulary_sp_txkea_vocabulary_3_sp', 'descriptor':'Vocabulary Wave 3', 'has_cp_col': True}]}
      ],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_decoding_sp': {
      'colname': 'txkea_decoding',
      'descriptor': 'Decoding',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_decoding_txkea_decoding_1', 'colname_spa': 'txkea_decoding_sp_txkea_decoding_1_sp', 'descriptor':'Decoding Wave 1', 'has_cp_col': True}]},
        {'wave_2':[{'colname':'txkea_decoding_txkea_decoding_2', 'colname_spa': 'txkea_decoding_sp_txkea_decoding_2_sp', 'descriptor':'Decoding Wave 2', 'has_cp_col': True}]},
        {'wave_3':[{'colname':'txkea_decoding_txkea_decoding_3', 'colname_spa': 'txkea_decoding_sp_txkea_decoding_3_sp', 'descriptor':'Decoding Wave 3', 'has_cp_col': True}]}
      ],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_letter_sounds_sp': { 
      'colname': 'txkea_letter_sounds',
      'descriptor': 'Letter Sounds',
      'subject_assess_type':'subject',
      'waves':[],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_blending_sp': {
      'colname': 'txkea_blending',
      'descriptor': 'Blending',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_blending_txkea_blending_1', 'colname_spa': 'txkea_blending_sp_txkea_blending_1_sp', 'descriptor':'Blending 1', 'has_cp_col': True}]},
        {'wave_2':[
          {'colname':'txkea_blending_txkea_blending_2_expressive', 'colname_spa': 'txkea_blending_sp_txkea_blending_2_expressive_sp', 'descriptor':'Blending 2 Expressive', 'module': 'Expressive', 'has_cp_col': False},
          {'colname':'txkea_blending_txkea_blending_2_receptive', 'colname_spa': 'txkea_blending_sp_txkea_blending_2_receptive_sp', 'descriptor':'Blending 2 Receptive', 'module': 'Receptive', 'has_cp_col': False}
          ]},
        {'wave_3':[
          {'colname':'txkea_blending_txkea_blending_3_receptive', 'colname_spa': 'txkea_blending_sp_txkea_blending_3_receptive_sp', 'descriptor':'Blending 3 Receptive', 'module': 'Receptive', 'has_cp_col': False},
          {'colname':'txkea_blending_txkea_blending_3_expressive', 'colname_spa': 'txkea_blending_sp_txkea_blending_3_expressive_sp', 'descriptor':'Blending 3 Expressive', 'module': 'Expressive', 'has_cp_col': False}
        ]}
      ],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_math_sp': {
      'colname': 'txkea_math',
      'descriptor': 'Math',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[
          {'colname':'txkea_math_txkea_math_part_1', 'colname_spa': 'txkea_math_sp_txkea_math_part_1_sp', 'descriptor':'Math Part 1', 'module': 'Part 1', 'has_cp_col': False},
          {'colname':'txkea_math_txkea_math_part_2', 'colname_spa': 'txkea_math_sp_txkea_math_part_2_sp', 'descriptor':'Math Part 2', 'module': 'Part 2', 'has_cp_col': False},
        ]},
        {'wave_2':[
          {'colname':'txkea_math_txkea_math_part_1_w2', 'colname_spa': 'txkea_math_sp_txkea_math_part_1_w2_sp', 'descriptor':'Math Part 1 W2', 'module': 'Part 1', 'has_cp_col': False},
          {'colname':'txkea_math_txkea_math_part_2_w2', 'colname_spa': 'txkea_math_sp_txkea_math_part_2_w2_sp', 'descriptor':'Math Part 2 W2', 'module': 'Part 2', 'has_cp_col': False}
        ]},
        {'wave_3':[
          {'colname':'txkea_math_txkea_math_part_1_w3', 'colname_spa': 'txkea_math_sp_txkea_math_part_1_w3_sp', 'descriptor':'Math Part 1 W3', 'module': 'Part 1', 'has_cp_col': False},
          {'colname':'txkea_math_txkea_math_part_2_w3', 'colname_spa': 'txkea_math_sp_txkea_math_part_2_w3_sp', 'descriptor':'Math Part 2 W3', 'module': 'Part 2', 'has_cp_col': False}
        ]}
      ],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_science_sp': {
      'colname': 'txkea_science',
      'descriptor': 'Science',
      'subject_assess_type':'subject',
      'waves':[
        {'wave_1':[{'colname':'txkea_science_txkea_science_1', 'colname_spa': 'txkea_science_sp_txkea_science_1_sp', 'descriptor':'Science 1', 'has_cp_col': True}]},
        {'wave_2':[{'colname':'txkea_science_txkea_science_2', 'colname_spa': 'txkea_science_sp_txkea_science_sp_2', 'descriptor':'Science 2', 'has_cp_col': True}]},
        {'wave_3':[{'colname':'txkea_science_txkea_science_3', 'colname_spa': 'txkea_science_sp_txkea_science_sp_3', 'descriptor':'Science 3', 'has_cp_col': True}]}
      ],
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_social_emotional_sp': {
      'colname': 'txkea_social_emotional',
      'descriptor': 'Social Emotional Competence',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_emotional_management_sp': {
      'colname': 'txkea_emotional_management',
      'descriptor': 'Emotion Management',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_working_memory_sp': {
      'colname': 'txkea_working_memory',
      'descriptor': 'Working Memory',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_inhibition_sp': {
      'colname': 'txkea_inhibition',
      'descriptor': 'Inhibition',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_attention_sp': {
      'colname': 'txkea_attention',
      'descriptor': 'Attention',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_academic_motor_sp': {
      'colname': 'txkea_academic_motor',
      'descriptor': 'Academic Motor Skills',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'Spanish',
      'has_cp_col': True
    },
    'txkea_sp_admin_mode': {
      'colname': 'txkea_en_admin_mode',
      'descriptor': 'Administration Mode',
      'subject_assess_type':'subject',
      'subject_assess_lang': 'Spanish',
      'has_cp_col': False
    },
  }
%}

{% set subjects = subjects_en.copy() %}
{% set _ = subjects.update(subjects_spa) %}

transformations:
  cli_tx_kea_student_assessment:
    source: $sources.cli_tx_kea_input
    operations:
      - operation: snake_case_columns 
      - operation: modify_columns
        columns:
          wave: "{%raw%}{{ wave |replace(' ', '_') }}{%endraw%}"
      - operation: add_columns
        columns:
          student_wave_id: '{%raw%}{{wave}}_{{school_year}}_{{student_engage_id}}{%endraw%}'


#--Subject Columns Creation------------------------------------
{% for subject_name, subject_values in subjects.items() %}
  cli_tx_kea_student_{{ subject_name }}:
    source: $transformations.cli_tx_kea_student_assessment
    operations:
      - operation: rename_columns
        columns:
          {{ subject_name }}: subject_score
          {{ subject_name }}_date: subject_date

      {% if subject_values.has_cp_col %}
      - operation: rename_columns
        columns:
          cp_{{ subject_name }}: subject_cut_point
      {% else %}
      - operation: add_columns
        columns:
          subject_cut_point: ''
      {% endif %}

      - operation: add_columns
        columns:
          subject_name: {{ subject_values.colname }}
          subject_descriptor: {{ subject_values.descriptor }}
          subject_assessment_type: {{ subject_values.subject_assess_type }}


#--Set Columns Creation------------------------------------
    {% set wave_number_subtest_number_dict = [] %}
    {% set wave_numbers_list = [] %}

    {% for wave in subject_values.waves %}
      {% for wave_item, wave_values in wave.items() %}
        {% for subtest in wave_values %}
          {% if subject_values.subject_assess_lang == 'English' %}
            {% set colname = subtest.colname %}
          {% elif subject_values.subject_assess_lang == 'Spanish' %}
            {% set colname = subtest.colname_spa %}
          {% endif %}

          {% set number_of_subtests_in_wave = [] %}
          {% set wave_number = wave_item.split('_')[-1] %}
          {% set subtest_number = loop.index %}

          # This operation will count the number of subtests in the current wave, to ensure we create null columns
          # of the difference.
          {% for n in range(1, wave_values | length + 1) %}
              {% set number_of_subtests_in_wave__append = number_of_subtests_in_wave.append(n) %}
          {% endfor %}

          {% set wave_numbers_list__append = wave_numbers_list.append(wave_number) %}
          {% set wave_number_subtest_number_dict__append = wave_number_subtest_number_dict.append({'wave_n': wave_number, 'subtest_n': [number_of_subtests_in_wave]}) %}

      - operation: rename_columns
        columns:
          {{ colname }}_date: subject_wave_{{ wave_number }}_subtest_{{ subtest_number }}_date
          {{ colname }}: subject_wave_{{ wave_number }}_subtest_{{ subtest_number }}_score
      - operation: add_columns
        columns:
          subject_wave_{{ wave_number }}_subtest_{{ subtest_number }}_name: {{ colname }}
          subject_wave_{{ wave_number }}_subtest_{{ subtest_number }}_descriptor: {{ subtest.descriptor }}
          subject_wave_{{ wave_number }}_subtest_{{ subtest_number }}_number: {{ wave_number }}

      {% if subtest.module is not none %}
      - operation: add_columns
        columns:
          subject_wave_{{ wave_number }}_subtest_{{ subtest_number }}_module: {{ subtest.module }}
      {% else %}
      - operation: add_columns
        columns:
          subject_wave_{{ wave_number }}_subtest_{{ subtest_number }}_module: ''
      {% endif %}

      {% if subtest.has_cp_col %}
      - operation: rename_columns
        columns:
          cp_{{ colname }}: subject_wave_{{ wave_number }}_subtest_{{ subtest_number }}_cut_point
      {% else %}
      - operation: add_columns
        columns:
          subject_wave_{{ wave_number }}_subtest_{{ subtest_number }}_cut_point: ''
      {% endif %}
      
        {% endfor %}
      {% endfor %}
    {% endfor %}

    {% for n in range(1, 4) %}
      {% if n|string not in wave_numbers_list %}
        {% set wave_number_subtest_number_dict__append = wave_number_subtest_number_dict.append({'wave_n': n, 'subtest_n': []}) %}
      {% endif %}
    {% endfor %}

    {% for wave_number in wave_number_subtest_number_dict %}
      {% for subtest_number in range(1, 3) %}
        {% if subtest_number|string not in wave_number.subtest_n|string %}
      - operation: add_columns
        columns:
          subject_wave_{{ wave_number.wave_n }}_subtest_{{ subtest_number }}_number: ''  
          subject_wave_{{ wave_number.wave_n }}_subtest_{{ subtest_number }}_name: ''  
          subject_wave_{{ wave_number.wave_n }}_subtest_{{ subtest_number }}_descriptor: '' 
          subject_wave_{{ wave_number.wave_n }}_subtest_{{ subtest_number }}_date: '' 
          subject_wave_{{ wave_number.wave_n }}_subtest_{{ subtest_number }}_score: '' 
          subject_wave_{{ wave_number.wave_n }}_subtest_{{ subtest_number }}_cut_point: '' 
          subject_wave_{{ wave_number.wave_n }}_subtest_{{ subtest_number }}_module: '' 
        {% endif %} 
      {% endfor %} 
    {% endfor %}  

#--Screening/Composite Column Creation------------------------------------
    {% if subject_values.subject_assess_type in ['composite', 'screener'] %}
      {% set remainder_subject_assess_type = (['composite', 'screener'] | reject("==", subject_values.subject_assess_type) | list ) %}
      {% set subject_assess_ref_numbers = [] %}
      {% for subject_assessments in subject_values.subject_assessments %}
        {% for subject_assess_ref, subject_assess_ref_values in subject_assessments.items() %}
          {% for subject_assess_item in subject_assess_ref_values%}
            {% if subject_values.subject_assess_lang == 'English' %}
              {% set subject_assess_ref_values_colname = subject_assess_item.subject_asses_ref_colname %}
            {% elif subject_values.subject_assess_lang == 'Spanish' %}
              {% set subject_assess_ref_values_colname = subject_assess_item.subject_asses_ref_colname_spa %}
            {% endif %}

      - operation: rename_columns
        columns:
      {% set sa_n = subject_assess_ref.split('_')[-1] %}
          {{ subject_assess_ref_values_colname }}: {{subject_values.subject_assess_type}}_assess_ref_{{ sa_n }}_score
      - operation: add_columns
        columns:
          {{subject_values.subject_assess_type}}_assess_ref_{{ sa_n }}_name: {{ subject_assess_ref_values_colname }}
          {{subject_values.subject_assess_type}}_assess_ref_{{ sa_n }}_descriptor: {{ subject_assess_item.subject_asses_ref_descriptor }}
          {{subject_values.subject_assess_type}}_assess_ref_{{ sa_n }}_number: {{ sa_n }}

      {% set subject_assess_ref_append = subject_assess_ref_numbers.append(sa_n) %}
          {% endfor %}
        {% endfor %}
      {% endfor %}

      {% for n in range(1, 4) %}
        {% if n|string not in subject_assess_ref_numbers %}
      - operation: add_columns
        columns:
          {{subject_values.subject_assess_type}}_assess_ref_{{ n }}_number: ''  
          {{subject_values.subject_assess_type}}_assess_ref_{{ n }}_name: ''  
          {{subject_values.subject_assess_type}}_assess_ref_{{ n }}_descriptor: '' 
          {{subject_values.subject_assess_type}}_assess_ref_{{ n }}_score: ''  
        {%- endif -%}      
      {%- endfor %}
      
      {% for n in range(1, 4) %}
        {% for remainder_subject in remainder_subject_assess_type %}
      - operation: add_columns
        columns:
          {{ remainder_subject }}_assess_ref_{{ n }}_number: ''  
          {{ remainder_subject }}_assess_ref_{{ n }}_name: ''  
          {{ remainder_subject }}_assess_ref_{{ n }}_descriptor: '' 
          {{ remainder_subject }}_assess_ref_{{ n }}_score: ''          
        {% endfor %}
      {% endfor %}
      
    {% else %}
        {% for n in range(1, 4) %}
      - operation: add_columns
        columns:
          screener_assess_ref_{{ n }}_number: ''  
          screener_assess_ref_{{ n }}_name: ''  
          screener_assess_ref_{{ n }}_descriptor: '' 
          screener_assess_ref_{{ n }}_score: ''  
          composite_assess_ref_{{ n }}_number: ''  
          composite_assess_ref_{{ n }}_name: ''  
          composite_assess_ref_{{ n }}_descriptor: '' 
          composite_assess_ref_{{ n }}_score: ''           
        {%- endfor %}      
    {% endif %}

      - operation: filter_rows
        query: subject_score != '' and subject_date != ''
        behavior: include 

      - operation: keep_columns
        columns: {{conformed_columns}}

{% endfor %}


  stacked_subject_scores:
    source: $transformations.cli_tx_kea_student_txkea_dyslexia_checklist
    operations:
      - operation: union
        sources:
{% for subject_name, subject_values in subjects.items() %}
    {% if subject_name != 'txkea_dyslexia_checklist' %}
          - $transformations.cli_tx_kea_student_{{ subject_name }}
    {% endif %}  
{% endfor %} 

destinations:
  studentAssessments:
    source: $transformations.stacked_subject_scores
    template: assessments/CLI_TX_KEA/templates/studentAssessments.jsont
    extension: jsonl
    linearize: False
    show_progress: True

  objectiveAssessments:
    source: $sources.objectiveAssessments
    template: assessments/CLI_TX_KEA/templates/objectiveAssessments.jsont
    extension: jsonl
    linearize: False
    show_progress: True

  assessmentReportingMethodDescriptors:
    source: $sources.assessmentReportingMethodDescriptors
    template: assessments/CLI_TX_KEA/templates/assessmentReportingMethodDescriptors.jsont
    extension: jsonl
    linearize: False
    show_progress: True

  assessments:
    source: $sources.assessments
    template: assessments/CLI_TX_KEA/templates/assessments.jsont
    extension: jsonl
    linearize: False
    show_progress: True